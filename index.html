<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¼ë•Œ & ì¡°ë¥˜ ì •ë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/korean-lunar-calendar/dist/korean-lunar-calendar.min.js"></script>
    <style>
        :root {
            --bg: #0a1628;
            --card: #111d35;
            --border: #1e3a5f;
            --primary: #4fc3f7;
            --accent: #00e5ff;
            --high: #ff6b6b;
            --low: #4ecdc4;
            --text: #e0e6ed;
            --muted: #7a8ba3;
            --warn: #ffa726;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 960px; margin: 0 auto; padding: 16px; }
        header { text-align: center; padding: 20px 0 12px; }
        header h1 { font-size: 1.6em; color: var(--accent); display: flex; align-items: center; justify-content: center; gap: 10px; }
        header h1 .wave { font-size: 1.3em; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; align-items: flex-end; }
        .control-group { flex: 1; min-width: 140px; }
        .control-group label { display: block; font-size: 0.78em; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input[type="date"] { width: 100%; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95em; font-family: 'Segoe UI', -apple-system, sans-serif; outline: none; cursor: pointer; }
        input[type="date"] { position: relative; color-scheme: dark; }
        input[type="date"]::-webkit-datetime-edit { color: var(--text); font-family: 'Segoe UI', -apple-system, sans-serif; }
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,195,247,0.2); }
        .btn { padding: 10px 24px; background: linear-gradient(135deg, #1a73e8, #4fc3f7); border: none; border-radius: 8px; color: #fff; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79,195,247,0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card-title { font-size: 1em; color: var(--primary); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .tide-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .tide-item { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .tide-item.high { border-left: 3px solid var(--high); }
        .tide-item.low { border-left: 3px solid var(--low); }
        .tide-item.diff { border-left: 3px solid var(--warn); }
        .tide-item .label { font-size: 0.85em; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .tide-item .value { font-size: 1.8em; font-weight: 700; margin: 4px 0; }
        .tide-item.high .value { color: var(--high); }
        .tide-item.low .value { color: var(--low); }
        .tide-item.diff .value { color: var(--warn); }
        .tide-item .time { font-size: 0.92em; color: var(--muted); }
        .chart-container { position: relative; height: 320px; }
        .current-table { width: 100%; border-collapse: collapse; }
        .current-table th { text-align: left; padding: 8px 12px; font-size: 0.78em; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .current-table td { padding: 10px 12px; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .speed-bar { height: 6px; border-radius: 3px; background: var(--border); overflow: hidden; margin-top: 4px; }
        .speed-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
        .loading { text-align: center; padding: 40px; color: var(--muted); }
        .loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--high); text-align: center; padding: 20px; font-size: 0.9em; }
        .tide-detail-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .tide-tag { padding: 6px 14px; border-radius: 20px; font-size: 0.82em; font-weight: 500; }
        .tide-tag.high { background: rgba(255,107,107,0.15); color: var(--high); }
        .tide-tag.low { background: rgba(78,205,196,0.15); color: var(--low); }
        .tide-item.sun { border-left: 3px solid #ffb74d; }
        .sun-row { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.05em; }
        .sun-row .sun-time { color: #ffb74d; font-weight: 700; font-size: 1.15em; }
        .sun-row .sun-label { color: var(--muted); font-size: 0.85em; }
        footer { text-align: center; padding: 20px; color: var(--muted); font-size: 0.75em; }
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
        .tab-btn { padding: 10px 20px; background: transparent; border: none; color: var(--muted); font-size: 0.9em; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:hover { color: var(--text); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ê²€ìƒ‰ ë°” */
        .search-bar { position: relative; margin-bottom: 16px; }
        .search-bar input { width: 100%; padding: 12px 16px 12px 40px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 0.95em; outline: none; }
        .search-bar input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,195,247,0.2); }
        .search-bar .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 1em; color: var(--muted); pointer-events: none; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: 10px; max-height: 320px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.4); margin-top: 4px; }
        .search-results.show { display: block; }
        .search-result-item { padding: 10px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .search-result-item:hover { background: rgba(79,195,247,0.1); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item .name { color: var(--text); font-size: 0.9em; }
        .search-result-item .name em { color: var(--accent); font-style: normal; font-weight: 600; }
        .search-result-item .tags { display: flex; gap: 4px; }
        .search-result-item .tag { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500; }
        .search-result-item .tag.obs { background: rgba(79,195,247,0.15); color: var(--primary); }
        .search-result-item .tag.crnt { background: rgba(0,229,255,0.15); color: var(--accent); }
        .search-result-item .tag.region { background: rgba(255,167,38,0.15); color: var(--warn); }
        .search-no-result { padding: 16px; text-align: center; color: var(--muted); font-size: 0.85em; }
        .region-badge { display: inline-block; padding: 2px 10px; border-radius: 10px; font-size: 0.72em; background: rgba(79,195,247,0.12); color: var(--primary); margin-left: 8px; vertical-align: middle; }
        .mulddae-card { display: flex; align-items: center; gap: 20px; flex-wrap: nowrap; }
        .mulddae-badge { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 90px; padding: 14px 20px; border-radius: 16px; font-weight: 700; flex-shrink: 0; }
        .mulddae-badge .mulddae-emoji { font-size: 1.8em; line-height: 1; }
        .mulddae-badge .mulddae-num { font-size: 1.4em; margin-top: 4px; }
        .mulddae-detail { flex: 1; font-size: 1em; color: var(--muted); line-height: 1.8; }
        .mulddae-detail .mulddae-title { font-size: 1.15em; color: var(--text); font-weight: 600; margin-bottom: 4px; }
        .mulddae-pct-bar { display: inline-block; width: 100px; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; vertical-align: middle; margin: 0 8px; }
        .mulddae-pct-bar-fill { height: 100%; border-radius: 5px; }
        .mulddae-desc { font-size: 0.95em; margin-top: 2px; }

        @media (max-width: 600px) {
            .controls { flex-direction: column; }
            .control-group { min-width: 100%; }
            .chart-container { height: 250px; }
            .tide-summary { grid-template-columns: 1fr 1fr; }
            header h1 { font-size: 1.3em; }
            .mulddae-card { flex-wrap: wrap; }
            .mulddae-badge { min-width: 80px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="wave">ğŸŒŠ</span> ë¬¼ë•Œ & ì¡°ë¥˜ ì •ë³´</h1>
        </header>

        <!-- ê²€ìƒ‰ -->
        <div class="search-bar" id="searchBar">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ (ì˜ˆ: ì¸ì²œ, ì˜¤ì²œí•­, ëŒ€ì²œí•­, ì—¬ìˆ˜...)" autocomplete="off" />
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label>ê´€ì¸¡ì†Œ (ì¡°ìœ„) <span class="region-badge" id="stationRegion">ì¸ì²œ/ê²½ê¸°</span></label>
                <select id="stationSelect"></select>
            </div>
            <div class="control-group">
                <label>ì¡°ë¥˜ ì˜ˆë³´ì  <span class="region-badge" id="currentRegion">ì¸ì²œ/ê²½ê¸°</span></label>
                <select id="currentSelect"></select>
            </div>
            <div class="control-group">
                <div style="display:flex;align-items:center;gap:4px;">
                    <span style="font-size:0.75em;color:var(--muted);text-align:center;min-width:52px;">â—€ ì›” â–¶</span>
                    <span style="font-size:0.75em;color:var(--muted);flex:1;text-align:center;">ë‚ ì§œ</span>
                    <span style="font-size:0.75em;color:var(--muted);text-align:center;min-width:52px;">â—€ ì¼ â–¶</span>
                </div>
                <div style="display:flex;align-items:center;gap:4px;">
                    <button class="btn" style="padding:6px 8px;font-size:0.8em;min-width:0;" onclick="shiftMonth(-1)">â—€</button>
                    <button class="btn" style="padding:6px 8px;font-size:0.8em;min-width:0;" onclick="shiftMonth(1)">â–¶</button>
                    <input type="date" id="dateInput" style="flex:1;" />
                    <button class="btn" style="padding:6px 8px;font-size:0.8em;min-width:0;" onclick="shiftDay(-1)">â—€</button>
                    <button class="btn" style="padding:6px 8px;font-size:0.8em;min-width:0;" onclick="shiftDay(1)">â–¶</button>
                </div>
            </div>
            <div class="control-group" style="flex:0;">
                <label>&nbsp;</label>
                <button class="btn" id="searchBtn" onclick="fetchAll()">ì¡°íšŒ</button>
            </div>
        </div>

        <!-- ë‚šì‹œ í¬ì¸íŠ¸ ì—°ê²° í‘œì‹œ ë°°ë„ˆ -->
        <div id="portBanner" style="display:none; margin-bottom:12px; padding:10px 16px; background:rgba(0,229,255,0.08); border:1px solid rgba(0,229,255,0.2); border-radius:10px; font-size:0.85em;">
            <span style="color:var(--accent);">ğŸ“ <strong id="portBannerName"></strong></span>
            <span style="color:var(--muted);margin-left:8px;">â†’ ì¡°ìœ„: <strong id="portBannerStation" style="color:var(--primary)"></strong> Â· ì¡°ë¥˜: <strong id="portBannerCurrent" style="color:var(--accent)"></strong></span>
            <span id="portBannerClose" style="float:right;cursor:pointer;color:var(--muted);font-size:1.1em;" title="ë‹«ê¸°">âœ•</span>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="tide">ë¬¼ë•Œ/ì¡°ìœ„</button>
            <button class="tab-btn" data-tab="current">ì¡°ë¥˜</button>
        </div>

        <!-- Tide Tab -->
        <div class="tab-content active" id="tab-tide">
            <div class="card" id="mulddaeCard" style="display:none;">
                <div class="card-title">ğŸŒ™ ì˜¤ëŠ˜ì˜ ë¬¼ë•Œ <span id="mulddaeDate" style="font-weight:400;color:var(--muted);font-size:0.9em;"></span></div>
                <div id="mulddaeInfo" class="mulddae-card"></div>
                <div id="mulddaeSpeciesInfo" style="display:none;margin-top:10px;"></div>
            </div>
            <div class="card" id="tideSummaryCard">
                <div class="card-title">ğŸ“Š ê³ ì €ì¡° ì •ë³´</div>
                <div id="tideSummary"><div style="text-align:center;color:var(--muted);padding:20px;">ê´€ì¸¡ì†Œì™€ ë‚ ì§œë¥¼ ì„ íƒ í›„ ì¡°íšŒí•˜ì„¸ìš”</div></div>
            </div>
            <div class="card">
                <div class="card-title" style="flex-wrap:wrap;gap:8px;">
                    <span>ğŸ“ˆ ì¡°ìœ„ ë³€í™” ê·¸ë˜í”„</span>
                    <div class="species-btns" style="display:flex;gap:6px;margin-left:auto;">
                        <button class="species-btn" data-species="none" onclick="toggleSpecies('none')" style="padding:4px 12px;border-radius:16px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:0.78em;cursor:pointer;transition:all 0.2s;">ì–´ì¢… OFF</button>
                        <button class="species-btn" data-species="jjukkumi" onclick="toggleSpecies('jjukkumi')" style="padding:4px 12px;border-radius:16px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:0.78em;cursor:pointer;transition:all 0.2s;">ğŸ™ ì­ˆê¾¸ë¯¸</button>
                        <button class="species-btn" data-species="gapoh" onclick="toggleSpecies('gapoh')" style="padding:4px 12px;border-radius:16px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:0.78em;cursor:pointer;transition:all 0.2s;">ğŸ¦‘ ê°‘ì˜¤ì§•ì–´</button>
                        <button class="species-btn" data-species="muneo" onclick="toggleSpecies('muneo')" style="padding:4px 12px;border-radius:16px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:0.78em;cursor:pointer;transition:all 0.2s;">ğŸ™ ë¬¸ì–´</button>
                    </div>
                </div>
                <div id="speciesLegend" style="display:none;margin-bottom:10px;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:0.8em;color:var(--muted);line-height:1.6;"></div>
                <div class="chart-container"><canvas id="tideChart"></canvas></div>
            </div>
        </div>

        <!-- Current Tab -->
        <div class="tab-content" id="tab-current">
            <div class="card">
                <div class="card-title">ğŸŒ€ ì¡°ë¥˜ ì •ë³´ (ìœ í–¥/ìœ ì†)</div>
                <div id="currentInfo"><div style="text-align:center;color:var(--muted);padding:20px;">ì¡°ë¥˜ ì˜ˆë³´ì ê³¼ ë‚ ì§œë¥¼ ì„ íƒ í›„ ì¡°íšŒí•˜ì„¸ìš”</div></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“ˆ ì¡°ë¥˜ ìœ ì† ê·¸ë˜í”„</div>
                <div class="chart-container"><canvas id="currentChart"></canvas></div>
            </div>
        </div>

        <footer>
            ë°ì´í„° ì¶œì²˜: êµ­ë¦½í•´ì–‘ì¡°ì‚¬ì› (ê³µê³µë°ì´í„°í¬í„¸)<br>
            â€» ì˜ˆì¸¡ ë°ì´í„°ì´ë©°, ì‹¤ì œ ê°’ê³¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </footer>
    </div>

    <script>
    // ==================== CONFIG ====================
    const API_BASE = 'https://tide-api-proxy.odk297.workers.dev';
    let tideChart = null;
    let currentChart = null;

    // ==================== ì§€ì—­ ë°ì´í„° (ê´€ì¸¡ì†Œ + ì¡°ë¥˜ ì˜ˆë³´ì  í†µí•©) ====================
    const REGIONS = [
        {
            key: 'incheon', label: 'ì¸ì²œ/ê²½ê¸°',
            stations: [
                ['DT_0001','ì¸ì²œ'],['DT_0052','ì¸ì²œì†¡ë„'],['DT_0044','ì˜ì¢…ëŒ€êµ'],['DT_0032','ê°•í™”ëŒ€êµ'],
                ['DT_0043','ì˜í¥ë„'],['DT_0093','ì†Œë¬´ì˜ë„'],['DT_0065','ë•ì ë„'],['DT_0066','í–¥í™”ë„'],
                ['DT_0002','í‰íƒ'],['DT_0008','ì•ˆì‚°']
            ],
            currents: [
                ['07GG03','ì„ëª¨ìˆ˜ë„'],['07GG06','ì¸ì²œê°‘ë¬¸'],['07GG11','ë•ì ë„'],['09IC01','ì¸ì²œë‚¨í•­'],
                ['09IC07','ê²½ì¸ì•„ë¼ë±ƒê¸¸'],['14IC03','ìì›”ë„ë¶ì¸¡'],['14IC04','ì´ì‘ë„ì„œì¸¡'],['16LTC01','ì¸ì²œëŒ€êµ'],
                ['16LTC02','ì¸ì²œë™ìˆ˜ë„ì…êµ¬'],['16DJ04','ì‹œí™”ë°©ì¡°ì œ'],['17LTC01','ì¸ì²œì‹ í•­ì…êµ¬'],['17LTC02','ê²½ê¸°ë§Œë¶ìˆ˜ë„'],
                ['19LTC01','í™”ì„±ë°©ì¡°ì œ'],['20LTC04','ì˜í¥ë„ì„œì¸¡'],['20LTC07','ìì›”ë„ë¶ì„œì¸¡'],['20LTC11','ë•ì êµ°ë„ì„œì¸¡'],
                ['20LTC12','ìˆ˜ìš°ë„ì„œì¸¡'],['05GH-5','ì¥ë´‰ìˆ˜ë„'],['15LTC01','ì—¼í•˜ìˆ˜ë„'],['03DS-1','ì¥ì•ˆì„œ']
            ]
        },
        {
            key: 'west_mid', label: 'ì¶©ë‚¨/ì „ë¶ (ì„œí•´ì¤‘ë¶€)',
            stations: [
                ['DT_0050','íƒœì•ˆ'],['DT_0067','ì•ˆí¥'],['DT_0017','ëŒ€ì‚°'],['DT_0025','ë³´ë ¹'],
                ['DT_0051','ì„œì²œë§ˆëŸ‰'],['DT_0024','ì¥í•­'],['DT_0018','êµ°ì‚°'],['DT_0068','ìœ„ë„'],['DT_0037','ì–´ì²­ë„']
            ],
            currents: [
                ['03PT-1','ì•„ì‚°ë§Œì…êµ¬'],['07DS02','ëŒ€ì‚°í•­'],['07TA03','íƒœì•ˆ'],['07TA04','ë§Œë¦¬í¬'],
                ['07TA05','ì•ˆí¥'],['07TA09','ê²©ë ¬ë¹„ì—´ë„'],['07KS01','ì›ì‚°ë„'],['07KS03','ì™¸ì—°ì—´ë„'],
                ['12JB11','ë¹„ì¸ë§Œ'],['12JB14','êµ°ì‚°í•­ì…êµ¬'],['13PT01','í‰íƒí•­'],['15LTC08','ì¥ê³ ë„ìˆ˜ë„'],
                ['16LTC03','ì²œìˆ˜ë§Œ'],['17LTC04','ë¬¸ê°‘ë„ë™ì¸¡'],['17LTC06','ê°€ë¡œë¦¼ë§Œì…êµ¬'],['19LTC02','ì™¸ì—°ë„ë™ì¸¡'],
                ['23GA01','ì•ˆë©´ë„ì„œì¸¡'],['24TJ02','ê°€ë¡œë¦¼ë§Œ'],['24TJ04','ì…íŒŒë„'],['24TJ05','ì•„ì‚°ë§Œ28í˜¸ë“±ë¶€í‘œ']
            ]
        },
        {
            key: 'west_south', label: 'ì „ë‚¨ì„œë¶€ (ëª©í¬/ì‹ ì•ˆ)',
            stations: [
                ['DT_0007','ëª©í¬'],['DT_0035','í‘ì‚°ë„'],['DT_0094','ì„œê±°ì°¨ë„']
            ],
            currents: [
                ['01MP-2','ëª©í¬êµ¬'],['06SA01','ë©´ë„ìˆ˜ë„'],['06SA10','íŒ”êµ¬í¬ë¶ì¸¡'],['06SA18','ê²½ì¹˜ë™ìˆ˜ë„'],
                ['06GS07','ê³ êµ°ì‚°êµ°ë„'],['07JB12','ìˆ˜ë„ìˆ˜ë„ë¶ì¸¡'],['07JB14','ìˆ˜ë„ìˆ˜ë„'],['10MP07','ì‹œì•„í•´'],
                ['14BP01','ë³‘í’ë„ë¶ì¸¡'],['15LTC02','ì–´ì²­ë„ì„œì¸¡'],['15LTC03','ìœ„ë„ë™ì¸¡'],['16LTC05','ëª©í¬ë¶í•­ë¶ì¸¡'],
                ['16LTC06','ì‹œì•„í•´ë¶ì¸¡'],['17LTC08','ë…¹ë„ë¶ì¸¡'],['17LTC09','ì‹­ì´ë™íŒŒë„'],['17LTC10','ê³ êµ°ì‚°êµ°ë„ë¶ì¸¡'],
                ['17MTC14','ìœ„ë„ì„œì¸¡'],['17MTC19','ì•ˆë§ˆë„ì„œì¸¡'],['17MTC20','ì•ˆë§ˆë„ë™ì¸¡'],['18LTC01','ë‚œì§€ë„ë¶ì¸¡'],
                ['18LTC02','ì™€ë„ì„œì¸¡'],['18LTC03','ì•ˆì¢Œë„ë¶ì¸¡'],['18LTC04','ë¹„ê¸ˆìˆ˜ë„'],['19LTC03','ì¬ì›ë™ìˆ˜ë„'],
                ['19LTC04','ì¦ë„ë™ì¸¡'],['19LTC05','ë§¤í™”ë„ì„œì¸¡'],['19LTC06','í•˜ì˜ìˆ˜ë„'],['20LTC01','ì–´ë¶ˆë„ì„œì¸¡'],
                ['20LTC02','ë…ê±°êµ°ë„ë¶ì¸¡'],['20LTC03','ì™¸ëª¨êµ°ë„ë‚¨ì¸¡'],['20LTC05','í•¨í‰ë§Œì…êµ¬'],['20LTC08','ìš°ì´ìˆ˜ë„'],
                ['20LTC09','ì†¡ì´ë„ë¶ì¸¡'],['22LTC12','ë§ˆëŸ‰í•­'],['22EW01','ëŒ€í™”ì‚¬ë„ì„œì¸¡'],['23LTC05','ìœ¨ë„ë¶ë™ì¸¡'],
                ['23LTC06','ëŒ€ì•¼ë„ë™ì¸¡'],['23LTC07','ìš°ì´ë„ë‚¨ì¸¡'],['23LTC08','ì¥ì‚°ë„ì„œì¸¡'],['23LTC09','ë‹¬ë¦¬ë„ì„œì¸¡'],
                ['24LTC01','ì¬ì›ë„ë‚¨ì„œì¸¡'],['24LTC02','ì–´ì˜ë„ë¶ì¸¡'],['24LTC03','ì•ˆë§ˆë„ë‚¨ì¸¡'],['24LTC04','ê±°ë¥œë„ë‚¨ì„œì¸¡'],
                ['24LTC05','ë§ë„ë‚¨ì¸¡'],['24LTC06','ì†Œíš¡ê²½ë„ë¶ì¸¡'],['24LTC07','ì‹­ì´ë™íŒŒë„ë‚¨ë™ì¸¡'],['24LTC08','ëŒ€í™”ì‚¬ë„ë‚¨ì¸¡'],
                ['24LTC09','ì‚½ì‹œë„ë¶ì¸¡'],['24LTC10','ì™¸íŒŒìˆ˜ë„ë‚¨ì¸¡'],['24LTC11','ê°€ì˜ë„ë¶ë™ì¸¡']
            ]
        },
        {
            key: 'south_west', label: 'ì „ë‚¨ë™ë¶€ (ì§„ë„/ì™„ë„/ì—¬ìˆ˜)',
            stations: [
                ['DT_0028','ì§„ë„'],['DT_0027','ì™„ë„'],['DT_0026','ê³ í¥ë°œí¬'],['DT_0092','ì—¬í˜¸í•­'],
                ['DT_0016','ì—¬ìˆ˜'],['DT_0049','ê´‘ì–‘'],['DT_0031','ê±°ë¬¸ë„']
            ],
            currents: [
                ['06JD01','ì™¸ë³‘ë„'],['06GH01','ë“ëŸ‰ë§Œì…êµ¬'],['06GH07','ê±°ê¸ˆë„ë‚¨ì¸¡'],['06YME1','ê´‘ë„ë™ì¸¡'],
                ['06YME4','ë³´ê¸¸ë„ë‚¨ì„œì¸¡'],['06YME5','ì¥ì£½ìˆ˜ë„'],['06YME6','ë§¹ê³¨ìˆ˜ë„'],['06YME8','ë§¤ë¬¼ìˆ˜ë„'],
                ['06YS03','ì‹ ê°•ìˆ˜ë„'],['06YS04','ì„œìˆ˜ë„(ì—¬ìë§Œ)'],['06YS09','ê±°ê¸ˆìˆ˜ë„'],['08GY-5','ë¬˜ë„ìˆ˜ë„'],
                ['11JD02','ì •ë“±í•´'],['11JD09','ë§ˆë¡œí•´'],['12YS08','ê´‘ì–‘í•­'],['13WD01','ì†Œì•ˆë„'],
                ['14JD03','ì •ë“±í•´ë¶ì¸¡'],['15LTC05','ë§Œì¬ë„ì„œì¸¡'],['15LTC06','ê±°ì°¨ìˆ˜ë„'],['15LTC07','ë…ê±°êµ°ë„ë™ì¸¡'],
                ['15LTC09','ê¸ˆë‹¹ìˆ˜ë„'],['15LTC10','ì—¬ìˆ˜í•´ë§Œ'],['15SE01','ë…¸ëŸ‰ìˆ˜ë„'],['15HD05','í•˜ë™í•­'],
                ['16LTC04','ì—­ë„'],['16LTC07','ì¥ì‚°ë„ë™ì¸¡'],['16LTC08','ê´‘ì–‘í•­ì œ1í•­ë¡œ'],['16LTC12','ë‚™ë™í¬'],
                ['17LTC11','ê°€ì‚¬ë„ë™ì¸¡'],['17LTC12','ì†Œì•ˆìˆ˜ë„'],['17LTC13','ì™„ë„í†µí•­ë¶„ë¦¬ëŒ€'],['18LTC05','í‘ì¼ë„ë‚¨ì¸¡'],
                ['18LTC06','ì—¬ìˆ˜í•´í˜‘'],['18LTC07','ì—¬ìˆ˜í•´ë§Œì…êµ¬'],['18MTC10','ì´ˆë„ë‚¨ì¸¡'],['19LTC07','ì²­ì‚°ë„ë™ì¸¡'],
                ['19LTC08','ëŒ€ë³‘í’ë„ì„œì¸¡'],['19LTC09','ì´ˆë„ë™ì¸¡'],['19LTC10','ì†ì£½ë„ë¶ì¸¡'],['19LTC11','ë‚˜ë¡œë„ë™ì¸¡'],
                ['19LTC12','ì—¬ìˆ˜í•´ë§Œë‚¨ì¸¡'],['19LTC13','ëŒ€ë³‘ëŒ€ë„ë™ì¸¡'],['20LTC06','ê¸ˆì˜¤ì—´ë„ë‚¨ì¸¡'],['20LTC13','ê´€ë¦¬ë„'],
                ['20LTC14','ê°€ë•ë„ë‚¨ì¸¡'],['20LTC15','ê±°ê¸ˆë„ë™ì¸¡'],['22LTC01','ì‚¼ì²œí¬-ì œì£¼í•­ë¡œ'],['22LTC02','ëŒ€ë°©ìˆ˜ë„'],
                ['22LTC03','ë…¸ëŸ‰ìˆ˜ë„ë™ì¸¡'],['22LTC04','ì™¸ìˆ˜ë„'],['22LTC05','ê¸ˆì˜¤ìˆ˜ë„'],['22LTC06','ë°±ì•¼ë„ë™ì¸¡'],
                ['22LTC07','ë°±ì•¼ìˆ˜ë„'],['22LTC08','ì™¸ë‚˜ë¡œë„ì„œì¸¡'],['22LTC09','ì†ì£½ë„ì„œì¸¡'],['22LTC10','ì†Œë¡ë„ë™ì¸¡'],
                ['22LTC13','ì²­ì‚°ë„ì„œì¸¡'],['22LTC14','í™©ì œë„ë™ì¸¡'],['22LTC15','ê´‘ì–‘í•­Aí˜¸ë“±ë¶€í‘œ'],
                ['23LTC01','ìš°ë„ë¶ì„œì¸¡'],['23LTC02','ì œì£¼ë„ì„œì¸¡'],['23LTC03','ë°±ì¼ë„ë™ì¸¡'],['23LTC04','ì–´ë£¡ë„ë¶ì¸¡'],
                ['23YG03','ì™¸ë‚˜ë¡œë„ë‚¨ì¸¡']
            ]
        },
        {
            key: 'south_east', label: 'ê²½ë‚¨ (í†µì˜/ê±°ì œ/ë¶€ì‚°)',
            stations: [
                ['DT_0061','ì‚¼ì²œí¬'],['DT_0014','í†µì˜'],['DT_0029','ê±°ì œë„'],['DT_0063','ê°€ë•ë„'],
                ['DT_0062','ë§ˆì‚°'],['DT_0056','ë¶€ì‚°í•­ì‹ í•­'],['DT_0005','ë¶€ì‚°']
            ],
            currents: [
                ['01SR-1','ì‚¬ëŸ‰ë„ë¶ì¸¡'],['08GA01','ê°ì²œí•­ì…êµ¬'],['10GD03','ê°€ë•ìˆ˜ë„'],['16LTC09','í†µì˜í•´ë§Œ'],
                ['16LTC10','ë¹„ì§„ë„ë‚¨ì¸¡'],['16LTC13','ë¶€ì‚°í•­ì…êµ¬'],['16MTC01','ë¯¸ì¡°ìˆ˜ë„'],['16MTC16','ì§€ì‹¬ë„ì„œì¸¡'],
                ['17LTC14','ìš•ì§€ë„ë¶ì¸¡'],['18LTC08','ë‘ë¯¸ë„ë¶ì¸¡'],['18LTC09','ì‚¬ëŸ‰ë„ë™ì¸¡'],['18LTC10','ê°€ì¡°ë„ìˆ˜ë„'],
                ['18LTC11','ì§„í•´ë§Œ(í†µì˜í•­ë¡œ)'],['18LTC12','ê±°ì œë„ë™ì¸¡'],['18LTC13','í•´ìš´ëŒ€'],['19LTC14','ê´‘ì•ˆë¦¬'],
                ['21LTC01','íƒœì¢…ëŒ€ë‚¨ì¸¡'],['21LTC02','ë¶í˜•ì œë„ë‚¨ì¸¡'],['21LTC03','ê°€ë•ë„ë‚¨ì„œì¸¡'],['21LTC04','ë¶€ì‚°í•­ì‹ í•­'],
                ['21LTC05','ì €ë„ì„œì¸¡'],['21LTC06','ë‚´ë„ë™ì¸¡'],['21LTC07','ì¹ ì²œë„ë¶ì„œì¸¡'],['21LTC08','ì¥ì‚¬ë„ë¶ì¸¡'],
                ['21LTC09','ìš©ì´ˆë„ë¶ì¸¡'],['21LTC10','ê²¬ë‚´ëŸ‰í•´í˜‘'],['21LTC11','ì˜¤ê³¡ë„ë¶ì¸¡'],['21LTC12','ê³¤ë¦¬ë„ë‚¨ì¸¡'],
                ['21LTC13','ì‚¬ëŸ‰ë„ë¶ë™ì¸¡'],['21LTC14','ì‹ ìˆ˜ë„ë™ì¸¡'],['98HG-1','íš¡ê°„ìˆ˜ë„']
            ]
        },
        {
            key: 'east', label: 'ë™í•´',
            stations: [
                ['DT_0020','ìš¸ì‚°'],['DT_0091','í¬í•­'],['DT_0039','ì™•ëŒì´ˆ'],['DT_0011','í›„í¬'],
                ['DT_0057','ë™í•´í•­'],['DT_0006','ë¬µí˜¸'],['DT_0012','ì†ì´ˆ'],['DT_0013','ìš¸ë¦‰ë„']
            ],
            currents: [
                ['16LTC14','ìš¸ì‚°ì‹ í•­'],['17LTC05','ìš¸ë„'],['17LTC07','ìš¸ë„ë‚¨ì¸¡'],['18LTC14','ëŒ€ì™•ì•”ë‚¨ì¸¡']
            ]
        },
        {
            key: 'jeju', label: 'ì œì£¼',
            stations: [
                ['DT_0004','ì œì£¼'],['DT_0022','ì„±ì‚°í¬'],['DT_0010','ì„œê·€í¬'],['DT_0023','ëª¨ìŠ¬í¬'],['DT_0021','ì¶”ìë„']
            ],
            currents: [
                ['02JJ-1','ì œì£¼í•­'],['08JJ03','ì„±ì‚°í¬'],['08JJ07','ì„œê·€í¬'],['08JJ13','ì• ì›”í•­ë¶ì¸¡'],
                ['08F','ì¶”ìë„ë‚¨ì„œì¸¡'],['10ED01','ì´ì–´ë„'],['22MTC03','ì œì£¼í•´í˜‘']
            ]
        },
        {
            key: 'ocean_base', label: 'í•´ì–‘ê³¼í•™ê¸°ì§€',
            stations: [
                ['DT_0042','êµë³¸ì´ˆ'],['IE_0060','ì´ì–´ë„'],['IE_0061','ì‹ ì•ˆê°€ê±°ì´ˆ'],['IE_0062','ì˜¹ì§„ì†Œì²­ì´ˆ']
            ],
            currents: []
        }
    ];

    // ==================== ë‚šì‹œ í¬ì¸íŠ¸ í”„ë¦¬ì…‹ (ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ/ì¡°ë¥˜ì˜ˆë³´ì  ë§¤í•‘) ====================
    const FISHING_PORTS = [
        { name: 'ì˜¤ì²œí•­', lat: 36.38, lon: 126.47, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '16LTC03', currentName: 'ì²œìˆ˜ë§Œ' },
        { name: 'ì‚¼ê¸¸í¬í•­', lat: 36.33, lon: 126.42, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '16LTC03', currentName: 'ì²œìˆ˜ë§Œ' },
        { name: 'ëŒ€ì²œí•­', lat: 36.32, lon: 126.51, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '07KS01', currentName: 'ì›ì‚°ë„' },
        { name: 'í™ì›í•­', lat: 36.30, lon: 126.48, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '07KS01', currentName: 'ì›ì‚°ë„' },
        { name: 'ë¬´ì°½í¬', lat: 36.27, lon: 126.54, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '07KS01', currentName: 'ì›ì‚°ë„' },
        { name: 'ì•ˆí¥ì™¸í•­', lat: 36.67, lon: 126.13, region: 'ì¶©ë‚¨', station: 'DT_0067', stationName: 'ì•ˆí¥', current: '07TA05', currentName: 'ì•ˆí¥' },
        { name: 'ê°„ì›”ë„', lat: 36.62, lon: 126.37, region: 'ì¶©ë‚¨', station: 'DT_0017', stationName: 'ëŒ€ì‚°', current: '17LTC06', currentName: 'ê°€ë¡œë¦¼ë§Œì…êµ¬' },
        { name: 'ê¶ë¦¬í¬êµ¬', lat: 36.78, lon: 126.12, region: 'ì¶©ë‚¨', station: 'DT_0050', stationName: 'íƒœì•ˆ', current: '07TA03', currentName: 'íƒœì•ˆ' },
        { name: 'ê²©í¬í•­', lat: 35.62, lon: 126.47, region: 'ì „ë¶', station: 'DT_0068', stationName: 'ìœ„ë„', current: '15LTC03', currentName: 'ìœ„ë„ë™ì¸¡' },
        { name: 'ë¶€ì•ˆë³€ì‚°', lat: 35.67, lon: 126.51, region: 'ì „ë¶', station: 'DT_0068', stationName: 'ìœ„ë„', current: '15LTC03', currentName: 'ìœ„ë„ë™ì¸¡' },
        { name: 'ë¹„ì‘í•­', lat: 35.97, lon: 126.62, region: 'ì „ë¶', station: 'DT_0018', stationName: 'êµ°ì‚°', current: '12JB14', currentName: 'êµ°ì‚°í•­ì…êµ¬' },
        { name: 'ì„ ìœ ë„', lat: 35.82, lon: 126.42, region: 'ì „ë¶', station: 'DT_0018', stationName: 'êµ°ì‚°', current: '06GS07', currentName: 'ê³ êµ°ì‚°êµ°ë„' },
        { name: 'ë…¹ë™í•­', lat: 34.48, lon: 127.08, region: 'ì „ë‚¨', station: 'DT_0026', stationName: 'ê³ í¥ë°œí¬', current: '06YS09', currentName: 'ê±°ê¸ˆìˆ˜ë„' },
        { name: 'ë§ˆëŸ‰í•­', lat: 34.38, lon: 126.38, region: 'ì „ë‚¨', station: 'DT_0007', stationName: 'ëª©í¬', current: '22LTC12', currentName: 'ë§ˆëŸ‰í•­' },
        { name: 'í•˜íš¨í•­', lat: 33.23, lon: 126.58, region: 'ì œì£¼', station: 'DT_0010', stationName: 'ì„œê·€í¬', current: '08JJ07', currentName: 'ì„œê·€í¬' },
        { name: 'ê¹€ë…•í•­', lat: 33.55, lon: 126.77, region: 'ì œì£¼', station: 'DT_0022', stationName: 'ì„±ì‚°í¬', current: '08JJ03', currentName: 'ì„±ì‚°í¬' },
        { name: 'í•œë¦¼í•­', lat: 33.42, lon: 126.27, region: 'ì œì£¼', station: 'DT_0004', stationName: 'ì œì£¼', current: '08JJ13', currentName: 'ì• ì›”í•­ë¶ì¸¡' },
        { name: 'ëŒ€í¬í•­', lat: 35.16, lon: 129.18, region: 'ê²½ë‚¨', station: 'DT_0005', stationName: 'ë¶€ì‚°', current: '18LTC13', currentName: 'í•´ìš´ëŒ€' },
        { name: 'êµ¬ë£¡í¬í•­', lat: 35.98, lon: 129.57, region: 'ê²½ë¶', station: 'DT_0091', stationName: 'í¬í•­', current: '17LTC05', currentName: 'ìš¸ë„' },
        { name: 'ì¶•ì‚°í•­', lat: 36.43, lon: 129.45, region: 'ê²½ë¶', station: 'DT_0011', stationName: 'í›„í¬', current: '17LTC07', currentName: 'ìš¸ë„ë‚¨ì¸¡' },
        { name: 'ì¥í˜¸í•­', lat: 37.28, lon: 129.33, region: 'ê°•ì›', station: 'DT_0057', stationName: 'ë™í•´í•­', current: null, currentName: null },
        { name: 'ì„ì›í•­', lat: 37.25, lon: 129.35, region: 'ê°•ì›', station: 'DT_0057', stationName: 'ë™í•´í•­', current: null, currentName: null },
    ];

    // ==================== ê´€ì¸¡ì†Œ/ì¡°ë¥˜ ì—°ë™ ====================
    function getRegionByStationCode(code) {
        for (const r of REGIONS) {
            if (r.stations.some(s => s[0] === code)) return r;
        }
        return REGIONS[0];
    }

    function getRegionByCurrentCode(code) {
        for (const r of REGIONS) {
            if (r.currents.some(c => c[0] === code)) return r;
        }
        return null;
    }

    function buildStationSelect() {
        const sel = document.getElementById('stationSelect');
        sel.innerHTML = '';
        for (const r of REGIONS) {
            const og = document.createElement('optgroup');
            og.label = r.label;
            for (const [code, name] of r.stations) {
                const opt = document.createElement('option');
                opt.value = code; opt.textContent = name;
                og.appendChild(opt);
            }
            sel.appendChild(og);
        }
    }

    function buildCurrentSelect(region) {
        const sel = document.getElementById('currentSelect');
        sel.innerHTML = '';
        if (!region || region.currents.length === 0) {
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = '(ì´ ì§€ì—­ì— ì¡°ë¥˜ ì˜ˆë³´ì  ì—†ìŒ)';
            sel.appendChild(opt);
            return;
        }
        const og = document.createElement('optgroup');
        og.label = region.label;
        for (const [code, name] of region.currents) {
            const opt = document.createElement('option');
            opt.value = code; opt.textContent = name;
            og.appendChild(opt);
        }
        sel.appendChild(og);
    }

    function updateRegionBadges(region) {
        document.getElementById('stationRegion').textContent = region.label;
        document.getElementById('currentRegion').textContent = region.label;
    }

    function onStationChange() {
        const code = document.getElementById('stationSelect').value;
        const region = getRegionByStationCode(code);
        buildCurrentSelect(region);
        updateRegionBadges(region);
    }

    // ==================== ê²€ìƒ‰ ê¸°ëŠ¥ ====================
    function buildSearchIndex() {
        const index = [];
        for (const r of REGIONS) {
            for (const [code, name] of r.stations) {
                index.push({ type: 'obs', code, name, region: r, regionLabel: r.label });
            }
            for (const [code, name] of r.currents) {
                index.push({ type: 'crnt', code, name, region: r, regionLabel: r.label });
            }
        }
        // ë‚šì‹œ í¬ì¸íŠ¸ í”„ë¦¬ì…‹ ì¶”ê°€
        for (const port of FISHING_PORTS) {
            index.push({ type: 'port', name: port.name, lat: port.lat, lon: port.lon, regionLabel: port.region });
        }
        return index;
    }

    const searchIndex = buildSearchIndex();

    function doSearch(query) {
        const q = query.trim().toLowerCase();
        if (!q) return [];
        return searchIndex.filter(item =>
            item.name.toLowerCase().includes(q) ||
            item.regionLabel.toLowerCase().includes(q) ||
            (item.code && item.code.toLowerCase().includes(q))
        ).slice(0, 15);
    }

    function highlightMatch(text, query) {
        const idx = text.toLowerCase().indexOf(query.toLowerCase());
        if (idx < 0) return text;
        return text.substring(0, idx) + '<em>' + text.substring(idx, idx + query.length) + '</em>' + text.substring(idx + query.length);
    }

    function renderSearchResults(results, query) {
        const el = document.getElementById('searchResults');
        if (results.length === 0) {
            el.innerHTML = '<div class="search-no-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            el.classList.add('show');
            return;
        }
        el.innerHTML = results.map((item, i) => {
            const typeLabel = item.type === 'obs' ? 'ê´€ì¸¡ì†Œ' : item.type === 'crnt' ? 'ì¡°ë¥˜ì˜ˆë³´ì ' : 'ğŸ“ ë‚šì‹œí¬ì¸íŠ¸';
            const typeClass = item.type === 'port' ? 'crnt' : item.type;
            return `
            <div class="search-result-item" data-idx="${i}">
                <div class="name">${highlightMatch(item.name, query)}</div>
                <div class="tags">
                    <span class="tag ${typeClass}">${typeLabel}</span>
                    <span class="tag region">${item.regionLabel}</span>
                </div>
            </div>`;
        }).join('');
        el.classList.add('show');

        el.querySelectorAll('.search-result-item').forEach(div => {
            div.addEventListener('click', () => {
                const idx = parseInt(div.dataset.idx);
                selectSearchResult(results[idx]);
            });
        });
    }

    function selectSearchResult(item) {
        const stationSel = document.getElementById('stationSelect');
        const currentSel = document.getElementById('currentSelect');

        if (item.type === 'port') {
            // ë‚šì‹œ í¬ì¸íŠ¸ â†’ ê¸°ì¡´ ê´€ì¸¡ì†Œ/ì¡°ë¥˜ ì»¨íŠ¸ë¡¤ì— ì—°ê²°
            const port = FISHING_PORTS.find(p => p.name === item.name);
            if (!port) return;

            // ê´€ì¸¡ì†Œ ì„¤ì •
            stationSel.value = port.station;
            const region = getRegionByStationCode(port.station);
            buildCurrentSelect(region);
            updateRegionBadges(region);

            // ì¡°ë¥˜ ì˜ˆë³´ì  ì„¤ì •
            if (port.current) {
                currentSel.value = port.current;
            }

            // ë°°ë„ˆ í‘œì‹œ
            document.getElementById('portBannerName').textContent = port.name;
            document.getElementById('portBannerStation').textContent = `${port.stationName} (${port.station})`;
            document.getElementById('portBannerCurrent').textContent = port.current ? `${port.currentName} (${port.current})` : 'ì˜ˆë³´ì  ì—†ìŒ';
            document.getElementById('portBanner').style.display = '';

            // ë¬¼ë•Œ/ì¡°ìœ„ íƒ­ìœ¼ë¡œ ì „í™˜
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="tide"]').classList.add('active');
            document.getElementById('tab-tide').classList.add('active');

            // ê²€ìƒ‰ì°½ ë‹«ê¸°
            document.getElementById('searchInput').value = item.name;
            document.getElementById('searchResults').classList.remove('show');

            // ìë™ ì¡°íšŒ
            fetchAll();
            return;
        }

        // í•´ë‹¹ ì§€ì—­ì˜ ê´€ì¸¡ì†Œë¥¼ ì²« ë²ˆì§¸ë¡œ ì„ íƒ
        const region = item.region;
        if (item.type === 'obs') {
            stationSel.value = item.code;
        } else {
            // ì¡°ë¥˜ì˜ˆë³´ì ì´ë©´ í•´ë‹¹ ì§€ì—­ì˜ ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œ ì„ íƒ
            if (region.stations.length > 0) {
                stationSel.value = region.stations[0][0];
            }
        }
        // ì§€ì—­ì— ë§ëŠ” ì¡°ë¥˜ ì˜ˆë³´ì  ëª©ë¡ ê°±ì‹ 
        buildCurrentSelect(region);
        updateRegionBadges(region);

        if (item.type === 'crnt') {
            currentSel.value = item.code;
        }

        // ë°°ë„ˆ ìˆ¨ê¸°ê¸°
        document.getElementById('portBanner').style.display = 'none';

        // ê²€ìƒ‰ì°½ ë‹«ê¸°
        document.getElementById('searchInput').value = item.name;
        document.getElementById('searchResults').classList.remove('show');

        // ìë™ ì¡°íšŒ
        fetchAll();
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        document.getElementById('dateInput').value = today.toISOString().split('T')[0];

        // ê´€ì¸¡ì†Œ/ì¡°ë¥˜ ì—°ë™ ì´ˆê¸°í™”
        buildStationSelect();
        onStationChange();
        document.getElementById('stationSelect').addEventListener('change', onStationChange);

        // ê¸°ë³¸ê°’: ì˜¤ì²œí•­
        const defaultPort = FISHING_PORTS.find(p => p.name === 'ì˜¤ì²œí•­');
        if (defaultPort) {
            selectSearchResult({ name: defaultPort.name, type: 'port' });
        }

        // í¬ì¸íŠ¸ ë°°ë„ˆ ë‹«ê¸° ë²„íŠ¼
        document.getElementById('portBannerClose').addEventListener('click', () => {
            document.getElementById('portBanner').style.display = 'none';
        });

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // ê²€ìƒ‰ ì´ë²¤íŠ¸
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let debounceTimer = null;

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const q = searchInput.value.trim();
                if (q.length === 0) { searchResults.classList.remove('show'); return; }
                const results = doSearch(q);
                renderSearchResults(results, q);
            }, 150);
        });

        searchInput.addEventListener('focus', () => {
            const q = searchInput.value.trim();
            if (q.length > 0) {
                const results = doSearch(q);
                renderSearchResults(results, q);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-bar')) {
                searchResults.classList.remove('show');
            }
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') searchResults.classList.remove('show');
            if (e.key === 'Enter') {
                e.preventDefault();
                const q = searchInput.value.trim();
                if (q.length === 0) return;
                const results = doSearch(q);
                if (results.length > 0) {
                    selectSearchResult(results[0]);
                }
            }
        });
    });

    function showToast(msg, isError = false) {
        let toast = document.getElementById('toastMsg');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toastMsg';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;color:#fff;font-size:14px;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;';
            document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.background = isError ? '#e74c3c' : '#00e0ff';
        toast.style.color = isError ? '#fff' : '#0a0f1a';
        toast.style.opacity = '1';
        setTimeout(() => { toast.style.opacity = '0'; }, 2500);
    }

    function shiftMonth(dir) {
        const inp = document.getElementById('dateInput');
        const d = new Date(inp.value);
        d.setMonth(d.getMonth() + dir);
        inp.value = d.toISOString().split('T')[0];
        fetchAll();
    }
    function shiftDay(dir) {
        const inp = document.getElementById('dateInput');
        const d = new Date(inp.value);
        d.setDate(d.getDate() + dir);
        inp.value = d.toISOString().split('T')[0];
        fetchAll();
    }
    function getDateStr() { return document.getElementById('dateInput').value.replace(/-/g, ''); }
    function getStation() { return document.getElementById('stationSelect').value; }
    function getCurrentStation() { return document.getElementById('currentSelect').value; }

    // ==================== ìŒë ¥ ë³€í™˜ & ë¬¼ë•Œ ê³„ì‚° ====================
    // korean-lunar-calendar ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (KASI ê¸°ë°˜ ì •í™•í•œ ìŒë ¥ ë³€í™˜)
    function solarToLunar(year, month, day) {
        try {
            const cal = new KoreanLunarCalendar();
            cal.setSolarDate(year, month, day);
            const lunar = cal.getLunarCalendar();
            return {
                lunarMonth: lunar.month,
                lunarDay: lunar.day,
                isLeapMonth: lunar.intercalation
            };
        } catch (e) {
            console.error('ìŒë ¥ ë³€í™˜ ì˜¤ë¥˜:', e);
            return { lunarMonth: 1, lunarDay: 1, isLeapMonth: false };
        }
    }

    function getMulddae(lunarDay) {
        // ë°”ë‹¤íƒ€ì„ ê¸°ì¤€ 7ë¬¼ë•Œì‹ (ì„œí•´ í‘œì¤€)
        // pctëŠ” ê¸°ë³¸ ì¶”ì •ê°’ (ì‹¤ì œ ì¡°ì°¨ ë°ì´í„°ë¡œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        const mulddaeMap = {
            1:  { name: 'ì‚¬ë¦¬', num: '7ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 98 },
            2:  { name: 'ì‚¬ë¦¬', num: '8ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 95 },
            3:  { name: 'ì‚¬ë¦¬', num: '9ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 90 },
            4:  { name: 'ì‚¬ë¦¬', num: '10ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 83 },
            5:  { name: 'ì‚¬ë¦¬', num: '11ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 73 },
            6:  { name: 'ì‚¬ë¦¬', num: '12ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 60 },
            7:  { name: 'ì‚¬ë¦¬', num: '13ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 45 },
            8:  { name: 'ì¡°ê¸ˆ', num: 'ì¡°ê¸ˆ', color: '#4ecdc4', emoji: 'ğŸŸ¢', pct: 30 },
            9:  { name: 'ë¬´ì‹œ', num: 'ë¬´ì‹œ', color: '#7a8ba3', emoji: 'âšª', pct: 25 },
            10: { name: 'ë“¤ë¬¼', num: '1ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 33 },
            11: { name: 'ë“¤ë¬¼', num: '2ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 43 },
            12: { name: 'ë“¤ë¬¼', num: '3ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 55 },
            13: { name: 'ë“¤ë¬¼', num: '4ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 68 },
            14: { name: 'ë“¤ë¬¼', num: '5ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 80 },
            15: { name: 'ì‚¬ë¦¬', num: '6ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 90 },
            16: { name: 'ì‚¬ë¦¬', num: '7ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 98 },
            17: { name: 'ì‚¬ë¦¬', num: '8ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 95 },
            18: { name: 'ì‚¬ë¦¬', num: '9ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 90 },
            19: { name: 'ì‚¬ë¦¬', num: '10ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 83 },
            20: { name: 'ì‚¬ë¦¬', num: '11ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 73 },
            21: { name: 'ì‚¬ë¦¬', num: '12ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 60 },
            22: { name: 'ì‚¬ë¦¬', num: '13ë¬¼', color: '#ffa726', emoji: 'ğŸŸ ', pct: 45 },
            23: { name: 'ì¡°ê¸ˆ', num: 'ì¡°ê¸ˆ', color: '#4ecdc4', emoji: 'ğŸŸ¢', pct: 30 },
            24: { name: 'ë¬´ì‹œ', num: 'ë¬´ì‹œ', color: '#7a8ba3', emoji: 'âšª', pct: 25 },
            25: { name: 'ë“¤ë¬¼', num: '1ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 33 },
            26: { name: 'ë“¤ë¬¼', num: '2ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 43 },
            27: { name: 'ë“¤ë¬¼', num: '3ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 55 },
            28: { name: 'ë“¤ë¬¼', num: '4ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 68 },
            29: { name: 'ë“¤ë¬¼', num: '5ë¬¼', color: '#4fc3f7', emoji: 'ğŸ”µ', pct: 80 },
            30: { name: 'ì‚¬ë¦¬', num: '6ë¬¼', color: '#ff6b6b', emoji: 'ğŸ”´', pct: 90 },
        };
        return mulddaeMap[lunarDay] || mulddaeMap[1];
    }

    // ê´€ì¸¡ì†Œë³„ ì‚¬ë¦¬ ê¸°ì¤€ ìµœëŒ€ ì¡°ì°¨ (cm) - ì‹¤ì¸¡ ê¸°ë°˜ ì°¸ê³ ê°’
    const MAX_TIDAL_RANGE = {
        // ì¸ì²œ/ê²½ê¸°
        'DT_0001': 900, 'DT_0052': 880, 'DT_0044': 870, 'DT_0032': 850,
        'DT_0043': 850, 'DT_0093': 860, 'DT_0065': 800, 'DT_0066': 780,
        'DT_0002': 850, 'DT_0008': 870,
        // ì¶©ë‚¨/ì „ë¶
        'DT_0050': 700, 'DT_0067': 650, 'DT_0017': 750, 'DT_0025': 750,
        'DT_0051': 650, 'DT_0024': 650, 'DT_0018': 600, 'DT_0068': 450, 'DT_0037': 400,
        // ì „ë‚¨ì„œë¶€
        'DT_0007': 400, 'DT_0035': 300, 'DT_0094': 350,
        // ì „ë‚¨ë™ë¶€
        'DT_0028': 350, 'DT_0027': 350, 'DT_0026': 350, 'DT_0092': 320,
        'DT_0016': 300, 'DT_0049': 300, 'DT_0031': 250,
        // ë‚¨í•´/ê²½ë‚¨
        'DT_0061': 250, 'DT_0014': 200, 'DT_0003': 200, 'DT_0029': 200,
        'DT_0063': 180, 'DT_0062': 180, 'DT_0056': 150,
        'DT_0013': 150, 'DT_0033': 180, 'DT_0015': 150, 'DT_0048': 130, 'DT_0030': 120,
        // ë¶€ì‚°/ìš¸ì‚°
        'DT_0005': 120, 'DT_0020': 50,
        // ë™í•´
        'DT_0091': 30, 'DT_0039': 30, 'DT_0011': 30, 'DT_0057': 30,
        'DT_0006': 35, 'DT_0012': 30,
        'DT_0019': 30, 'DT_0034': 30, 'DT_0036': 25,
        // ì œì£¼
        'DT_0004': 250, 'DT_0022': 200, 'DT_0010': 200, 'DT_0023': 200, 'DT_0021': 350,
        // íŠ¹ìˆ˜ (êµë³¸ì´ˆ/ì´ì–´ë„/ê°€ê±°ì´ˆ/ì†Œì²­ì´ˆ)
        'DT_0042': 300, 'IE_0060': 200, 'IE_0061': 350, 'IE_0062': 800,
    };

    // ì‹¤ì œ ì¡°ì°¨ ê¸°ë°˜ ë¬¼íë¦„ % ê³„ì‚°
    function calcFlowPct(diff, stationCode) {
        if (diff == null || diff <= 0) return null;
        const maxRange = MAX_TIDAL_RANGE[stationCode] || 300; // fallback: ë¯¸ë“±ë¡ ê´€ì¸¡ì†Œìš© ì¤‘ê°„ê°’
        const pct = Math.round(Math.min(100, (diff / maxRange) * 100));
        return Math.max(5, pct); // ìµœì†Œ 5%
    }

    function getMulddaeInfo(dateStr) {
        const y = parseInt(dateStr.substring(0, 4));
        const m = parseInt(dateStr.substring(4, 6));
        const d = parseInt(dateStr.substring(6, 8));
        const lunar = solarToLunar(y, m, d);
        const mulddae = getMulddae(lunar.lunarDay);
        return { ...mulddae, lunarMonth: lunar.lunarMonth, lunarDay: lunar.lunarDay };
    }

    // ==================== ì¼ì¶œ/ì¼ëª° ì²œë¬¸ê³„ì‚° (SunCalc ì•Œê³ ë¦¬ì¦˜) ====================
    // ê´€ì¸¡ì†Œ ì½”ë“œ â†’ ìœ„ë„/ê²½ë„ ë§¤í•‘
    const STATION_COORDS = {
        // ì¸ì²œ/ê²½ê¸°
        'DT_0001': [37.45, 126.59], 'DT_0052': [37.35, 126.65], 'DT_0044': [37.53, 126.57],
        'DT_0032': [37.73, 126.53], 'DT_0043': [37.25, 126.47], 'DT_0093': [37.38, 126.42],
        'DT_0065': [37.23, 126.15], 'DT_0066': [37.18, 126.20], 'DT_0002': [36.97, 126.82],
        'DT_0008': [37.18, 126.65],
        // ì¶©ë‚¨/ì „ë¶
        'DT_0050': [36.90, 126.17], 'DT_0067': [36.67, 126.13], 'DT_0017': [36.97, 126.37],
        'DT_0025': [36.40, 126.55], 'DT_0051': [36.07, 126.52], 'DT_0024': [36.00, 126.68],
        'DT_0018': [35.97, 126.72], 'DT_0068': [35.62, 126.30], 'DT_0037': [36.12, 125.85],
        // ì „ë‚¨ì„œë¶€
        'DT_0007': [34.78, 126.38], 'DT_0035': [34.68, 125.43], 'DT_0094': [34.42, 125.95],
        // ì „ë‚¨ë™ë¶€
        'DT_0028': [34.48, 127.73], 'DT_0027': [34.73, 127.75], 'DT_0026': [34.48, 127.08],
        'DT_0092': [34.57, 127.30], 'DT_0016': [34.75, 127.77], 'DT_0049': [34.30, 127.53],
        'DT_0031': [34.30, 126.52],
        // ë‚¨í•´/ê²½ë‚¨
        'DT_0061': [34.83, 128.42], 'DT_0014': [34.85, 128.43], 'DT_0003': [35.08, 128.03],
        'DT_0029': [34.92, 128.07], 'DT_0063': [34.73, 128.33], 'DT_0062': [34.80, 128.57],
        'DT_0056': [34.70, 128.73], 'DT_0013': [34.82, 128.60], 'DT_0033': [34.85, 128.43],
        'DT_0015': [34.73, 128.02], 'DT_0048': [34.75, 128.90], 'DT_0030': [34.92, 127.90],
        // ë¶€ì‚°/ìš¸ì‚°
        'DT_0005': [35.08, 129.03], 'DT_0020': [35.50, 129.38],
        // ë™í•´
        'DT_0091': [36.02, 129.57], 'DT_0039': [37.48, 129.17], 'DT_0011': [36.68, 129.48],
        'DT_0057': [37.48, 129.13], 'DT_0006': [38.20, 128.60], 'DT_0012': [37.87, 128.83],
        'DT_0019': [36.40, 129.38], 'DT_0034': [37.08, 129.40], 'DT_0036': [36.73, 129.47],
        // ì œì£¼
        'DT_0004': [33.52, 126.53], 'DT_0022': [33.47, 126.93], 'DT_0010': [33.25, 126.57],
        'DT_0023': [33.47, 126.93], 'DT_0021': [33.52, 126.25],
    };

    function getSunTimes(date, lat, lon) {
        // ì²œë¬¸ê³„ì‚° ê¸°ë°˜ ì¼ì¶œ/ì¼ëª° (NOAA ì•Œê³ ë¦¬ì¦˜ ê°„ì†Œí™”)
        const rad = Math.PI / 180;
        const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
        const lngHour = lon / 15;

        // ì¼ì¶œ/ì¼ëª° ê³„ì‚° í•¨ìˆ˜
        function calcSunTime(rising) {
            const t = rising ? dayOfYear + (6 - lngHour) / 24 : dayOfYear + (18 - lngHour) / 24;

            // íƒœì–‘ í‰ê· ê·¼ì ì´ê°
            const M = (0.9856 * t) - 3.289;

            // íƒœì–‘ í™©ê²½
            let L = M + (1.916 * Math.sin(M * rad)) + (0.020 * Math.sin(2 * M * rad)) + 282.634;
            L = ((L % 360) + 360) % 360;

            // íƒœì–‘ ì ê²½
            let RA = Math.atan(0.91764 * Math.tan(L * rad)) / rad;
            RA = ((RA % 360) + 360) % 360;

            const Lquad = Math.floor(L / 90) * 90;
            const RAquad = Math.floor(RA / 90) * 90;
            RA = RA + (Lquad - RAquad);
            RA = RA / 15;

            // íƒœì–‘ ì ìœ„
            const sinDec = 0.39782 * Math.sin(L * rad);
            const cosDec = Math.cos(Math.asin(sinDec));

            // ì‹œê°„ê° (ì¼ì¶œ/ì¼ëª°: -0.833ë„ = ëŒ€ê¸°êµ´ì ˆ ë³´ì •)
            const zenith = 90.833;
            const cosH = (Math.cos(zenith * rad) - (sinDec * Math.sin(lat * rad))) / (cosDec * Math.cos(lat * rad));

            if (cosH > 1 || cosH < -1) return null; // ê·¹ì§€ë°© ì²˜ë¦¬

            let H = rising
                ? (360 - Math.acos(cosH) / rad) / 15
                : Math.acos(cosH) / rad / 15;

            const T = H + RA - (0.06571 * t) - 6.622;
            let UT = ((T - lngHour) % 24 + 24) % 24;

            // KST (UTC+9)
            let KST = UT + 9;
            if (KST >= 24) KST -= 24;

            const hours = Math.floor(KST);
            const minutes = Math.round((KST - hours) * 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        return {
            sunrise: calcSunTime(true),
            sunset: calcSunTime(false)
        };
    }

    function getSunTimesForStation(dateStr, stationCode) {
        // FISHING_PORTSì—ì„œ í˜„ì¬ ê´€ì¸¡ì†Œì— ë§¤ì¹­ë˜ëŠ” í¬íŠ¸ ì¢Œí‘œ ìš°ì„ , ì—†ìœ¼ë©´ STATION_COORDS ì‚¬ìš©
        const port = FISHING_PORTS.find(p => p.station === stationCode);
        let lat, lon;
        if (port) {
            lat = port.lat;
            lon = port.lon;
        } else if (STATION_COORDS[stationCode]) {
            [lat, lon] = STATION_COORDS[stationCode];
        } else {
            // fallback: ì„œìš¸ ê¸°ì¤€
            lat = 37.5; lon = 126.97;
        }

        const y = parseInt(dateStr.substring(0, 4));
        const m = parseInt(dateStr.substring(4, 6)) - 1;
        const d = parseInt(dateStr.substring(6, 8));
        return getSunTimes(new Date(y, m, d), lat, lon);
    }

    // ==================== GENERIC API CALL (Worker í”„ë¡ì‹œ ê²½ìœ ) ====================
    const PROXY_ENDPOINT_MAP = {
        'tideFcstHghLw/GetTideFcstHghLwApiService': '/api/tide-hilo',
        'surveyTideLevel/GetSurveyTideLevelApiService': '/api/tide-level',
        'crntFcstTime/GetCrntFcstTimeApiService': '/api/current',
    };

    async function apiCall(path, params) {
        const endpoint = PROXY_ENDPOINT_MAP[path];
        if (!endpoint) throw new Error(`Unknown API path: ${path}`);

        const url = new URL(`${API_BASE}${endpoint}`);
        if (params.obsCode) url.searchParams.set('obsCode', params.obsCode);
        if (params.reqDate) url.searchParams.set('reqDate', params.reqDate);

        const resp = await fetch(url.toString());
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const json = await resp.json();

        if (json.header && json.header.resultCode !== '00') {
            throw new Error(json.header.resultMsg || 'API ì˜¤ë¥˜');
        }
        return json.body?.items?.item || [];
    }

    // ==================== FETCH ALL ====================
    async function fetchAll() {
        const btn = document.getElementById('searchBtn');
        btn.disabled = true; btn.textContent = 'ì¡°íšŒ ì¤‘...';
        try {
            await Promise.all([fetchTideHighLow(), fetchTidePrediction(), fetchCurrentData()]);
        } catch(e) { console.error(e); }
        finally { btn.disabled = false; btn.textContent = 'ì¡°íšŒ'; }
    }

    // ==================== 1) ê³ ì €ì¡° (tideFcstHghLw) ====================
    async function fetchTideHighLow() {
        const summaryEl = document.getElementById('tideSummary');
        summaryEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>ê³ ì €ì¡° ë°ì´í„° ë¡œë”©...</div></div>';

        try {
            const items = await apiCall('tideFcstHghLw/GetTideFcstHghLwApiService', {
                obsCode: getStation(),
                reqDate: getDateStr(),
                numOfRows: '20',
                pageNo: '1'
            });

            if (!items || items.length === 0) {
                summaryEl.innerHTML = '<div class="error-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const dateStr = getDateStr();
            const datePrefix = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
            const todayItems = items.filter(i => i.predcDt && i.predcDt.startsWith(datePrefix));
            const displayItems = todayItems.length > 0 ? todayItems : items.slice(0, 4);

            const highs = displayItems.filter(i => parseInt(i.extrSe) % 2 === 1);
            const lows = displayItems.filter(i => parseInt(i.extrSe) % 2 === 0);

            const maxHigh = highs.length > 0 ? Math.max(...highs.map(h => h.predcTdlvVl)) : null;
            const minLow = lows.length > 0 ? Math.min(...lows.map(l => l.predcTdlvVl)) : null;
            const diff = (maxHigh !== null && minLow !== null) ? maxHigh - minLow : null;

            const bestHigh = highs.length > 0 ? highs.reduce((a, b) => a.predcTdlvVl > b.predcTdlvVl ? a : b) : null;
            const bestLow = lows.length > 0 ? lows.reduce((a, b) => a.predcTdlvVl < b.predcTdlvVl ? a : b) : null;

            // ë¬¼ë•Œ ì •ë³´ í‘œì‹œ (ì‹¤ì œ ì¡°ì°¨ ê¸°ë°˜ ë¬¼íë¦„ % ì ìš©)
            const mulddae = getMulddaeInfo(dateStr);
            const realPct = calcFlowPct(diff, getStation());
            if (realPct !== null) {
                mulddae.pct = realPct;
            }
            const mulddaeEl = document.getElementById('mulddaeInfo');
            const mulddaeCard = document.getElementById('mulddaeCard');
            mulddaeCard.style.display = '';
            document.getElementById('mulddaeDate').textContent = `${dateStr.substring(0,4)}.${dateStr.substring(4,6)}.${dateStr.substring(6,8)}`;
            const desc = mulddae.num === 'ì¡°ê¸ˆ' ? 'ì†Œì¡°ê¸° â€” ì¡°ì°¨ê°€ ê°€ì¥ ì‘ê³  ë¬¼ì‚´ì´ ì•½í•©ë‹ˆë‹¤'
                : mulddae.num === 'ë¬´ì‹œ' ? 'ì¡°ê¸ˆ ì§í›„ â€” ë¬¼íë¦„ì´ ê°€ì¥ ì•½í•œ ë‚ ì…ë‹ˆë‹¤'
                : mulddae.name === 'ì‚¬ë¦¬' && mulddae.pct >= 90 ? 'ëŒ€ì¡°ê¸° â€” ì¡°ì°¨ê°€ í¬ê³  ë¬¼ì‚´ì´ ì…‰ë‹ˆë‹¤'
                : mulddae.name === 'ì‚¬ë¦¬' ? 'ì‚¬ë¦¬ ì „í›„ â€” ì¡°ì°¨ê°€ ì ì°¨ ì¤„ì–´ë“­ë‹ˆë‹¤'
                : 'ë“¤ë¬¼ â€” ì¡°ê¸ˆâ†’ì‚¬ë¦¬ ì „í™˜ê¸°, ì¡°ì°¨ê°€ ì»¤ì§€ëŠ” ì¤‘ì…ë‹ˆë‹¤';
            const speciesFit = getSpeciesByMulddae(mulddae.num, mulddae.pct);
            mulddaeEl.innerHTML = `
                <div class="mulddae-badge" style="background:${mulddae.color}22; color:${mulddae.color};">
                    <span class="mulddae-emoji">${mulddae.emoji}</span>
                    <span class="mulddae-num">${mulddae.num}</span>
                </div>
                <div class="mulddae-detail">
                    <div class="mulddae-title">${mulddae.name} Â· ìŒë ¥ ${mulddae.lunarMonth}ì›” ${mulddae.lunarDay}ì¼</div>
                    <div>ë¬¼íë¦„ <div class="mulddae-pct-bar"><div class="mulddae-pct-bar-fill" style="width:${mulddae.pct}%;background:${mulddae.color};"></div></div> <span style="color:${mulddae.color};font-weight:600;">${mulddae.pct}%</span>${realPct !== null ? ' <span style="font-size:0.75em;color:var(--muted);">(ì¡°ì°¨ ' + diff + 'cm ê¸°ì¤€)</span>' : ''}</div>
                    <div class="mulddae-desc">${desc}</div>
                    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                        ${speciesFit.map(s => `<div style="display:flex;align-items:center;gap:5px;padding:4px 10px;background:${s.color}15;border:1px solid ${s.color}33;border-radius:8px;font-size:0.82em;">
                            <span>${s.emoji}</span>
                            <span style="color:var(--text);font-weight:600;">${s.name}</span>
                            <span style="color:${s.color};font-weight:700;">${s.grade}</span>
                            <span style="color:var(--muted);font-size:0.85em;">${s.desc}</span>
                        </div>`).join('')}
                    </div>
                </div>`;

            // ë‚šì‹œ ì‹œê°„ëŒ€ í•„í„°: 18:00~05:00 (ì•¼ê°„) ê³ ì €ì¡° ì „ë¶€ ì œì™¸
            const filteredItems = displayItems.filter(i => {
                const time = i.predcDt.substring(11, 16);
                return time >= '05:00' && time <= '18:00';
            });

            // ì¼ì¶œ/ì¼ëª° ê³„ì‚°
            const sunTimes = getSunTimesForStation(getDateStr(), getStation());

            summaryEl.innerHTML = `
                <div class="tide-summary">
                    <div class="tide-item high">
                        <div class="label">ìµœê³ ì¡°ìœ„</div>
                        <div class="value">${maxHigh !== null ? maxHigh.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div>
                        <div class="time">${bestHigh ? bestHigh.predcDt.substring(11, 16) : '-'}</div>
                    </div>
                    <div class="tide-item low">
                        <div class="label">ìµœì €ì¡°ìœ„</div>
                        <div class="value">${minLow !== null ? minLow.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div>
                        <div class="time">${bestLow ? bestLow.predcDt.substring(11, 16) : '-'}</div>
                    </div>
                    <div class="tide-item diff">
                        <div class="label">ì¡°ì°¨ (ê³ ì €ì°¨)</div>
                        <div class="value">${diff !== null ? diff.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div>
                        <div class="time">${diff !== null ? (diff / 100).toFixed(2) + ' m' : '-'}</div>
                    </div>
                </div>`;

            window._hlData = displayItems;
        } catch(e) {
            summaryEl.innerHTML = `<div class="error-msg">ê³ ì €ì¡° ì˜¤ë¥˜: ${e.message}</div>`;
        }
    }

    // ==================== 2) 10ë¶„ ë‹¨ìœ„ ì¡°ìœ„ ê·¸ë˜í”„ (surveyTideLevel) ====================
    // ê³ ì €ì¡° í¬ì¸íŠ¸ ì‚¬ì´ë¥¼ ì½”ì‚¬ì¸ ë³´ê°„ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ ì˜ˆì¸¡ ê³¡ì„  ìƒì„±
    function interpolateFromHiLo(hlData) {
        if (!hlData || hlData.length < 2) return { labels: [], predicted: [] };

        // ê³ ì €ì¡° í¬ì¸íŠ¸ë¥¼ ë¶„ ë‹¨ìœ„ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
        const points = hlData.map(item => {
            const time = item.predcDt.substring(11, 16);
            const [h, m] = time.split(':').map(Number);
            return { min: h * 60 + m, val: item.predcTdlvVl };
        }).sort((a, b) => a.min - b.min);

        // 10ë¶„ ê°„ê²©ìœ¼ë¡œ 00:00~23:50 ë¼ë²¨ ìƒì„±
        const labels = [];
        const predicted = [];
        for (let t = 0; t < 24 * 60; t += 10) {
            const hh = String(Math.floor(t / 60)).padStart(2, '0');
            const mm = String(t % 60).padStart(2, '0');
            labels.push(`${hh}:${mm}`);

            // í˜„ì¬ ì‹œê°ì´ ì–´ëŠ ë‘ í¬ì¸íŠ¸ ì‚¬ì´ì— ìˆëŠ”ì§€ ì°¾ê¸°
            let val = null;
            if (t <= points[0].min) {
                // ì²« í¬ì¸íŠ¸ ì´ì „: ì²« í¬ì¸íŠ¸ ê°’ ìœ ì§€
                val = points[0].val;
            } else if (t >= points[points.length - 1].min) {
                // ë§ˆì§€ë§‰ í¬ì¸íŠ¸ ì´í›„: ë§ˆì§€ë§‰ ê°’ ìœ ì§€
                val = points[points.length - 1].val;
            } else {
                for (let i = 0; i < points.length - 1; i++) {
                    if (t >= points[i].min && t <= points[i + 1].min) {
                        const ratio = (t - points[i].min) / (points[i + 1].min - points[i].min);
                        // ì½”ì‚¬ì¸ ë³´ê°„: ìì—°ìŠ¤ëŸ¬ìš´ ì¡°ìœ„ ê³¡ì„ 
                        const cosRatio = (1 - Math.cos(ratio * Math.PI)) / 2;
                        val = points[i].val + (points[i + 1].val - points[i].val) * cosRatio;
                        break;
                    }
                }
            }
            predicted.push(val !== null ? Math.round(val * 10) / 10 : null);
        }
        return { labels, predicted };
    }

    async function fetchTidePrediction() {
        try {
            let items = [];
            try {
                items = await apiCall('surveyTideLevel/GetSurveyTideLevelApiService', {
                    obsCode: getStation(),
                    reqDate: getDateStr(),
                    min: '10',
                    numOfRows: '300',
                    pageNo: '1'
                });
            } catch(e) {
                // ì‹¤ì¸¡ API ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ (ë¯¸ë˜ ë‚ ì§œ ë“±)
            }

            const hlData = window._hlData || [];
            let labels, predicted, actual;

            if (items && items.length > 0) {
                // ì‹¤ì¸¡ ë°ì´í„° ìˆìŒ (ê³¼ê±°/ì˜¤ëŠ˜)
                labels = items.map(d => d.obsrvnDt.substring(11, 16));
                predicted = items.map(d => d.bscTdlvHgt);
                actual = items.map(d => d.tdlvHgt);

                // ì˜¤ëŠ˜: ì‹¤ì¸¡ì´ 18:00 ë¯¸ë§Œì´ë©´ ê³ ì €ì¡° ë³´ê°„ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ì˜ˆì¸¡ ì±„ì›€
                const lastLabel = labels[labels.length - 1];
                if (lastLabel && lastLabel < '18:00' && hlData.length >= 2) {
                    const interp = interpolateFromHiLo(hlData);
                    const lastMin = (() => { const [h,m] = lastLabel.split(':').map(Number); return h * 60 + m; })();
                    for (let i = 0; i < interp.labels.length; i++) {
                        const [ih, im] = interp.labels[i].split(':').map(Number);
                        const iMin = ih * 60 + im;
                        if (iMin > lastMin) {
                            labels.push(interp.labels[i]);
                            predicted.push(interp.predicted[i]);
                            actual.push(null); // ì‹¤ì¸¡ ì—†ìŒ
                        }
                    }
                }
            } else if (hlData.length >= 2) {
                // ì‹¤ì¸¡ ì—†ìŒ, ê³ ì €ì¡° ì˜ˆë³´ë¡œ ë³´ê°„ ê³¡ì„  ìƒì„± (ë¯¸ë˜)
                const interp = interpolateFromHiLo(hlData);
                labels = interp.labels;
                predicted = interp.predicted;
                actual = null;
            } else {
                renderTideChart([], []); return;
            }

            // 05:00~18:00 ë²”ìœ„ë§Œ í•„í„°ë§
            const timeFilter = (lbl) => { const h = parseInt(lbl.split(':')[0]); return h >= 5 && h <= 18; };
            const filterIndices = labels.map((l, i) => timeFilter(l) ? i : -1).filter(i => i >= 0);
            const fLabels = filterIndices.map(i => labels[i]);
            const fPredicted = filterIndices.map(i => predicted[i]);
            const fActual = actual ? filterIndices.map(i => actual[i]) : null;

            let annotations = {};
            hlData.forEach((item, idx) => {
                const time = item.predcDt.substring(11, 16);
                const nearIdx = fLabels.findIndex(l => {
                    const [h1, m1] = l.split(':').map(Number);
                    const [h2, m2] = time.split(':').map(Number);
                    return Math.abs((h1 * 60 + m1) - (h2 * 60 + m2)) <= 5;
                });
                if (nearIdx < 0) return;
                const isHigh = parseInt(item.extrSe) % 2 === 1;

                annotations['hl_' + idx] = {
                    type: 'point', xValue: nearIdx, yValue: item.predcTdlvVl,
                    backgroundColor: isHigh ? 'rgba(255,107,107,0.8)' : 'rgba(78,205,196,0.8)',
                    radius: 7, borderColor: '#fff', borderWidth: 2,
                };
                annotations['hl_label_' + idx] = {
                    type: 'label', xValue: nearIdx,
                    yValue: item.predcTdlvVl,
                    yAdjust: isHigh ? 24 : -24,
                    content: `${isHigh ? 'ê³ ì¡°' : 'ì €ì¡°'} ${item.predcTdlvVl.toFixed(0)}cm`,
                    color: isHigh ? '#ff6b6b' : '#4ecdc4',
                    font: { size: 11, weight: 'bold' },
                };
                annotations['hl_time_' + idx] = {
                    type: 'label', xValue: nearIdx,
                    yValue: item.predcTdlvVl,
                    yAdjust: isHigh ? -21 : 18,
                    content: time,
                    color: isHigh ? '#ff6b6b' : '#4ecdc4',
                    font: { size: 10, weight: '600' },
                };
            });

            // ì¼ì¶œ/ì¼ëª° ê·¸ë˜í”„ ë§ˆì»¤
            const sunTimes = getSunTimesForStation(getDateStr(), getStation());
            [
                { key: 'sunrise', time: sunTimes.sunrise, emoji: 'ğŸŒ…', label: 'ì¼ì¶œ', color: '#ffb74d' },
                { key: 'sunset',  time: sunTimes.sunset,  emoji: 'ğŸŒ‡', label: 'ì¼ëª°', color: '#ff8a65' }
            ].forEach(sun => {
                if (!sun.time) return;
                const sunIdx = fLabels.findIndex(l => {
                    const [h1, m1] = l.split(':').map(Number);
                    const [h2, m2] = sun.time.split(':').map(Number);
                    return Math.abs((h1 * 60 + m1) - (h2 * 60 + m2)) <= 5;
                });
                if (sunIdx < 0) return;
                const sunY = fPredicted[sunIdx] != null ? fPredicted[sunIdx] : 0;
                annotations['sun_point_' + sun.key] = {
                    type: 'point', xValue: sunIdx, yValue: sunY,
                    backgroundColor: 'rgba(255,183,77,0.8)',
                    radius: 7, borderColor: '#fff', borderWidth: 2,
                };
                annotations['sun_label_' + sun.key] = {
                    type: 'label', xValue: sunIdx, yValue: sunY,
                    yAdjust: -20,
                    content: sun.emoji + ' ' + sun.time,
                    color: sun.color, font: { size: 10, weight: 'bold' },
                };
            });

            // í™œì„±ë„ ë°ì´í„° ì €ì¥ (ì–´ì¢… ë²„íŠ¼ìš©)
            window._chartData = { labels: fLabels, predicted: fPredicted, actual: fActual, annotations };
            renderTideChart(fLabels, fPredicted, fActual, annotations);
        } catch(e) {
            console.error('ì¡°ìœ„ ê·¸ë˜í”„ ì˜¤ë¥˜:', e);
            renderTideChart([], []);
        }
    }

    // ==================== ì–´ì¢…ë³„ í™œì„±ë„ ê³„ì‚° ====================
    // ì¡°ìœ„ ë³€í™”ìœ¨(ê¸°ìš¸ê¸°)ë¡œ ì¡°ë¥˜ ê°•ë„ë¥¼ ì¶”ì •í•˜ê³ , ì–´ì¢…ë³„ íŒ¨í„´ì— ë§ì¶° í™œì„±ë„ ì‚°ì¶œ
    // ì¶œì²˜: ë‚šì‹œ ì»¤ë®¤ë‹ˆí‹° ì¢…í•© (ë°”ë‹¤íƒ€ì„, í”¼ì‹±íŠ¸ë¦½, ë‚šì‹œì¶˜ì¶” ë“±)
    //
    // ğŸ™ ì­ˆê¾¸ë¯¸: ì¤‘ê°„~ê°•í•œ ì¡°ë¥˜ ì‹œ í™œì„± â†‘ (ë“¤ë¬¼/ë‚ ë¬¼ ì¤‘ë°˜). ì •ì¡° ì‹œ í™œì„± â†“
    // ğŸ¦‘ ê°‘ì˜¤ì§•ì–´: ì¡°ë¥˜ íë¥¼ ë•Œ í™œì„± â†‘ (ì¤‘ë“¤ë¬¼/ì¤‘ì°ë¬¼). ì •ì¡° ì‹œ ì…ì§ˆ ëŠê¹€. ê°„ì¡° ì „í›„ ì›Œí‚¹ ì¢‹ìŒ
    // ğŸ™ ë¬¸ì–´: ì¡°ë¥˜ ì•½í•´ì§€ëŠ” ì •ì¡° ì „í›„ í™œì„± â†‘ (ì´ˆë“¤ë¬¼ í™©ê¸ˆì‹œê°„). ê°•í•œ ì¡°ë¥˜ ì‹œ í™œì„± â†“

    // â”€â”€ ì •ì¡°/ë¬¼ëŒì´ ì‹œê°„ ìƒìˆ˜ (10ë¶„ ê°„ê²© ê¸°ì¤€) â”€â”€
    const SLACK_HALF = 3;  // ì •ì¡°: ì¤‘ì‹¬ Â±3 = 6í¬ì¸íŠ¸ = 1ì‹œê°„
    const TURN_LEN = 6;   // ë¬¼ëŒì´: 6í¬ì¸íŠ¸ = 1ì‹œê°„

    // â”€â”€ ì–´ì¢…ë³„ pct íŒì • í†µí•© ìƒìˆ˜ â”€â”€
    // grade ìƒ‰ìƒ (í•œ ê³³ì—ì„œ ê´€ë¦¬)
    const GRADE_COLORS = {
        'ìµœìƒ': '#69f0ae', 'ì¢‹ìŒ': '#4fc3f7', 'ë³´í†µ': '#ffa726', 'ë‚®ìŒ': '#ff6b6b'
    };

    // ì–´ì¢…ë³„ íŒì • ê·œì¹™ (ì„ê³„ê°’ + ì„¤ëª… í†µí•©)
    const SPECIES_RULES = {
        jjukkumi: {
            emoji: 'ğŸ™', name: 'ì­ˆê¾¸ë¯¸',
            // ì„ ìƒ: ì¡°ê¸ˆ~ì¤‘ë¬¼ ì„ í˜¸, ì¤‘ê°„ ì¡°ë¥˜ ìµœì 
            rules: [
                { cond: (p, n) => n === 'ì¡°ê¸ˆ' || n === 'ë¬´ì‹œ', grade: 'ì¢‹ìŒ', desc: 'ì•½í•œ ì¡°ë¥˜, ë°”ë‹¥ íƒìƒ‰ ìš©ì´', mulddaeDesc: 'ì¡°ë¥˜ ì•½í•œ ë‚  â€” ë°”ë‹¥ íƒìƒ‰ìœ¼ë¡œ ì…ì§ˆ ê°€ëŠ¥, ì„ ìƒ ì í•©' },
                { cond: (p, n) => n === '1ë¬¼' || n === '2ë¬¼',   grade: 'ìµœìƒ', desc: 'ì„ ìƒ ìµœì  â€” ì ì • ì¡°ë¥˜', mulddaeDesc: (n) => `${n} â€” ì´ˆë“¤ë¬¼, ì„ ìƒ ìµœì  ì¡°ë¥˜` },
                { cond: (p, n) => p >= 40 && p <= 70,           grade: 'ìµœìƒ', desc: 'ì¤‘ê°„ ì¡°ë¥˜, í™œì„± ìµœê³ ', mulddaeDesc: (n) => `${n} â€” ì¤‘ê°„ ì¡°ë¥˜ë¡œ ì„ ìƒ ì­ˆê¾¸ë¯¸ ìµœì !` },
                { cond: (p, n) => p >= 80,                      grade: 'ë³´í†µ', desc: 'ì¡°ë¥˜ ê°•í•´ ì±„ë¹„ ì»¨íŠ¸ë¡¤ ì–´ë ¤ì›€', mulddaeDesc: (n) => `${n} â€” ì¡°ë¥˜ ê°•í•´ ì±„ë¹„ ì»¨íŠ¸ë¡¤ ì£¼ì˜ (ë¬´ê±°ìš´ ë´‰ëŒ í•„ìš”)` },
                { cond: (p, n) => p >= 30,                      grade: 'ì¢‹ìŒ', desc: 'ì ë‹¹í•œ ì¡°ë¥˜', mulddaeDesc: (n) => `${n} â€” ì ë‹¹í•œ ì¡°ë¥˜, ì¢‹ì€ ì¡°ê±´` },
                { cond: () => true,                             grade: 'ì¢‹ìŒ', desc: 'ì •ì¡°ì—ë„ ë°”ë‹¥ ì…ì§ˆ ê°€ëŠ¥', mulddaeDesc: (n) => `${n} â€” ì ë‹¹í•œ ì¡°ë¥˜, ì¢‹ì€ ì¡°ê±´` }
            ]
        },
        gapoh: {
            emoji: 'ğŸ¦‘', name: 'ê°‘ì˜¤ì§•ì–´',
            // ì„ ìƒ: 3~8ë¬¼ ì ì • ì¡°ë¥˜ ìµœì , ì •ì¡° ì‹œ í™œì„± ë‚®ìŒ
            rules: [
                { cond: (p, n) => n === 'ì¡°ê¸ˆ' || n === 'ë¬´ì‹œ', grade: 'ë‚®ìŒ', desc: 'ì¡°ë¥˜ ë¶€ì¡±, í™œì„± ë‚®ìŒ', mulddaeDesc: 'ì¡°ë¥˜ ë¶€ì¡±í•œ ë‚  â€” í™œì„± ë‚®ìŒ, ì¶œì¡° ë¹„ì¶”ì²œ' },
                { cond: (p, n) => p >= 55 && p <= 85,           grade: 'ìµœìƒ', desc: '3~8ë¬¼ ì ì • ì¡°ë¥˜, ìµœì ', mulddaeDesc: (n) => `${n} â€” 3~8ë¬¼ ì ì • ì¡°ë¥˜, ê°‘ì˜¤ì§•ì–´ ìµœì !` },
                { cond: (p, n) => p >= 85,                      grade: 'ì¢‹ìŒ', desc: 'ì¡°ë¥˜ ê°•í•˜ì§€ë§Œ í™œì„± ìˆìŒ', mulddaeDesc: (n) => `${n} â€” ê°•í•œ ì¡°ë¥˜, ì¥ì• ë¬¼ ë’¤ ë§¤ë³µ í¬ì¸íŠ¸ ê³µëµ` },
                { cond: (p, n) => p >= 35,                      grade: 'ë³´í†µ', desc: 'ì•½í•œ ì¡°ë¥˜, ì •ì¡° ì‹œê°„ ì£¼ì˜', mulddaeDesc: (n) => `${n} â€” ì•½í•œ ì¡°ë¥˜, ë¬¼ëŒì´ íƒ€ì„ ì§‘ì¤‘` },
                { cond: () => true,                             grade: 'ë‚®ìŒ', desc: 'ì¡°ë¥˜ ë¶€ì¡±', mulddaeDesc: 'ì¡°ë¥˜ ë¶€ì¡±' }
            ]
        },
        muneo: {
            emoji: 'ğŸ™', name: 'ë¬¸ì–´',
            // ì •ì¡° ì „í›„ í™œì„±â†‘, ì´ˆë“¤ë¬¼ í™©ê¸ˆì‹œê°„, ê°•í•œ ì¡°ë¥˜ ì‹œ ì€ì‹ 
            rules: [
                { cond: (p, n) => n === 'ì¡°ê¸ˆ' || n === 'ë¬´ì‹œ', grade: 'ìµœìƒ', desc: 'ì •ì¡° ë§ì•„ ë¨¹ì´í™œë™ í™œë°œ', mulddaeDesc: 'ì •ì¡° ë§ì€ ë‚  â€” ë¨¹ì´í™œë™ í™œë°œ, ë¬¸ì–´ ìµœì !' },
                { cond: (p, n) => n === '1ë¬¼' || n === '2ë¬¼',   grade: 'ìµœìƒ', desc: 'ì´ˆë“¤ë¬¼ í™©ê¸ˆì‹œê°„ ë§ìŒ', mulddaeDesc: (n) => `${n} â€” ì´ˆë“¤ë¬¼ í™©ê¸ˆì‹œê°„ ë§ìŒ, ìµœì !` },
                { cond: (p, n) => p >= 80,                      grade: 'ë‚®ìŒ', desc: 'ê°•í•œ ì¡°ë¥˜, ì€ì‹  ê²½í–¥', mulddaeDesc: (n) => `${n} â€” ê°•í•œ ì¡°ë¥˜, ì •ì¡° ì‹œê°„ëŒ€ë§Œ ë…¸ë ¤ì•¼` },
                { cond: (p, n) => p >= 55,                      grade: 'ë³´í†µ', desc: 'ì •ì¡° ì‹œê°„ëŒ€ ë…¸ë ¤ì•¼ í•¨', mulddaeDesc: (n) => `${n} â€” ì •ì¡° ì „í›„ ì‹œê°„ëŒ€ ì§‘ì¤‘ ê³µëµ` },
                { cond: () => true,                             grade: 'ì¢‹ìŒ', desc: 'ì•½í•œ ì¡°ë¥˜, í™œë™ â†‘', mulddaeDesc: (n) => `${n} â€” ì•½í•œ ì¡°ë¥˜, í™œë™ â†‘` }
            ]
        }
    };

    // í†µí•© íŒì • í•¨ìˆ˜: ì–´ì¢… í‚¤ + pct + ë¬¼ë•Œì´ë¦„ â†’ { grade, color, desc, mulddaeDesc }
    function getSpeciesSuitability(speciesKey, pct, num) {
        const species = SPECIES_RULES[speciesKey];
        if (!species) return null;
        for (const rule of species.rules) {
            if (rule.cond(pct, num)) {
                const mulddaeText = typeof rule.mulddaeDesc === 'function' ? rule.mulddaeDesc(num) : rule.mulddaeDesc;
                return { grade: rule.grade, color: GRADE_COLORS[rule.grade], desc: rule.desc, mulddaeDesc: mulddaeText };
            }
        }
        return null;
    }

    // ë¬¼ë•Œ(ëª‡ë¬¼)ë³„ ì–´ì¢… ì í•©ë„ â€” ë¬¼ë•Œ ì¹´ë“œì— í‘œì‹œ
    function getSpeciesByMulddae(mulddaeNum, mulddaePct) {
        return Object.entries(SPECIES_RULES).map(([key, sp]) => {
            const suit = getSpeciesSuitability(key, mulddaePct, mulddaeNum);
            return { emoji: sp.emoji, name: sp.name, ...suit };
        });
    }

    // ì„ ìƒë‚šì‹œ ê¸°ì¤€ ì–´ì¢…ë³„ ì„¤ì •
    // ë¬¼ëŒì´(Turn of Tide) = ì •ì¡°â†’ìœ ì† ì „í™˜ ì‹œì‘ì  = ìµœê³  í”¼ë”©íƒ€ì„
    const SPECIES_CONFIG = {
        jjukkumi: {
            name: 'ì­ˆê¾¸ë¯¸', emoji: 'ğŸ™', color: '#e040fb',
            legend: 'ğŸ™ ì­ˆê¾¸ë¯¸ â€” ì¤‘ê°„ ì¡°ë¥˜ ì‹œ í™œì„± ìµœê³  | ì •ì¡°ì—ë„ ë°”ë‹¥ íƒìƒ‰ìœ¼ë¡œ ì…ì§ˆ ìˆìŒ | ì„ ìƒ ì¡°ê¸ˆ~ì¤‘ë¬¼ ì í•©'
        },
        gapoh: {
            name: 'ê°‘ì˜¤ì§•ì–´', emoji: 'ğŸ¦‘', color: '#ff9100',
            legend: 'ğŸ¦‘ ê°‘ì˜¤ì§•ì–´ â€” ì´ˆë“¤ë¬¼ í”¼ë”©íƒ€ì„ | ë“¤ë¬¼ > ë‚ ë¬¼ | ì •ì¡° ì‹œ ì…ì§ˆê°ì§€ ì–´ë ¤ì›€'
        },
        muneo: {
            name: 'ë¬¸ì–´', emoji: 'ğŸ™', color: '#69f0ae',
            legend: 'ğŸ™ ë¬¸ì–´ â€” ì •ì¡° ì „í›„ ë¨¹ì´í™œë™ â†‘ | ì´ˆë“¤ë¬¼ í™©ê¸ˆì‹œê°„ | ê°•í•œ ì¡°ë¥˜ ì‹œ ì€ì‹ '
        }
    };

    let activeSpecies = 'none';

    function calcTideRates(predicted) {
        const n = predicted.length;
        if (n < 2) return predicted.map(() => 0);

        // 1ë‹¨ê³„: ë„“ì€ ìœˆë„ìš°(ì „í›„ 6í¬ì¸íŠ¸=1ì‹œê°„)ë¡œ ë³€í™”ìœ¨ ê³„ì‚°
        const W = 6;
        const rawRates = [];
        for (let i = 0; i < n; i++) {
            const lo = Math.max(0, i - W);
            const hi = Math.min(n - 1, i + W);
            if (predicted[lo] != null && predicted[hi] != null && hi > lo) {
                rawRates.push((predicted[hi] - predicted[lo]) / (hi - lo));
            } else {
                rawRates.push(0);
            }
        }

        // 2ë‹¨ê³„: ì´ë™í‰ê·  ìŠ¤ë¬´ë”© (ìœˆë„ìš° 9í¬ì¸íŠ¸)
        const SW = 9;
        const smoothed = [];
        for (let i = 0; i < n; i++) {
            let sum = 0, cnt = 0;
            for (let j = Math.max(0, i - SW); j <= Math.min(n - 1, i + SW); j++) {
                sum += rawRates[j]; cnt++;
            }
            smoothed.push(cnt > 0 ? sum / cnt : 0);
        }

        // 3ë‹¨ê³„: ì •ê·œí™” (ìµœëŒ€ ì ˆëŒ€ê°’ ê¸°ì¤€ 0~1)
        const maxAbs = Math.max(...smoothed.map(Math.abs), 0.001);
        return smoothed.map(v => v / maxAbs);
    }

    function toggleSpecies(species) {
        activeSpecies = (activeSpecies === species) ? 'none' : species;

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.species-btn').forEach(btn => {
            const s = btn.dataset.species;
            if (s === activeSpecies) {
                const cfg = SPECIES_CONFIG[s];
                btn.style.background = cfg ? cfg.color + '22' : 'rgba(255,255,255,0.1)';
                btn.style.borderColor = cfg ? cfg.color : 'var(--muted)';
                btn.style.color = cfg ? cfg.color : 'var(--text)';
            } else {
                btn.style.background = 'transparent';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--muted)';
            }
        });

        // speciesLegend â†’ ì¢‹ì€/ì•ˆì¢‹ì€ ì‹œê°„ëŒ€ í‘œì‹œ (ì°¨íŠ¸ ìœ„)
        updateSpeciesTimeRanges();

        // ë¬¼ë•Œ ì¹´ë“œì— ì„ íƒëœ ì–´ì¢… ì„¤ëª… ì—…ë°ì´íŠ¸
        updateMulddaeSpeciesInfo();

        // ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if (window._chartData) {
            const { labels, predicted, actual, annotations } = window._chartData;
            renderTideChart(labels, predicted, actual, annotations);
        }
    }

    // ì°¨íŠ¸ ìœ„ speciesLegendì— ë¬¼ëŒì´ ì‹œê°„ ë° ì–´ì¢… ë²”ë¡€ í‘œì‹œ
    function updateSpeciesTimeRanges() {
        const legendEl = document.getElementById('speciesLegend');
        if (activeSpecies === 'none' || !SPECIES_CONFIG[activeSpecies] || !window._chartData) {
            legendEl.style.display = 'none';
            return;
        }
        const cfg = SPECIES_CONFIG[activeSpecies];
        const { labels, predicted } = window._chartData;
        if (!predicted || predicted.length === 0) { legendEl.style.display = 'none'; return; }

        // ê¸°ì¡´ ê³ ì¡°/ì €ì¡° annotation ìœ„ì¹˜ ê¸°ë°˜ ì •ì¡°/ë¬¼ëŒì´ ì‹œê° ê°ì§€
        const rates = calcTideRates(predicted);
        const slackZones = [];
        const turnTimes = [];
        const anns = window._chartData.annotations || {};
        const hlPoints = [];
        Object.keys(anns).forEach(key => {
            if (key.match(/^hl_\d+$/) && anns[key].xValue != null) {
                hlPoints.push(anns[key].xValue);
            }
        });
        hlPoints.sort((a, b) => a - b);
        hlPoints.forEach(center => {
            const redStart = Math.max(0, center - SLACK_HALF);
            const redEnd = Math.min(labels.length - 1, center + SLACK_HALF);
            const turnEnd = Math.min(labels.length - 1, redEnd + TURN_LEN);
            slackZones.push({ start: labels[redStart] || '', end: labels[redEnd] || '' });
            const turnRate = rates[redEnd] != null ? rates[redEnd] : 0;
            turnTimes.push({ time: labels[redEnd] || '', type: turnRate > 0 ? 'ë“¤ë¬¼' : 'ë‚ ë¬¼' });
        });

        legendEl.style.display = '';
        legendEl.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="color:${cfg.color};font-weight:700;font-size:0.95em;">${cfg.legend}</span>
            </div>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                ${slackZones.length > 0 ? `
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span style="font-size:0.82em;color:#ff5252;font-weight:700;">â¸ ì •ì¡° êµ¬ê°„</span>
                    ${slackZones.map(z => `
                        <div style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:rgba(255,82,82,0.08);border-radius:6px;border-left:3px solid #ff5252;">
                            <span style="font-size:0.85em;color:var(--text);font-weight:600;">${z.start}~${z.end}</span>
                        </div>
                    `).join('')}
                </div>` : ''}
                ${turnTimes.length > 0 ? `
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span style="font-size:0.82em;color:#4caf50;font-weight:700;">ğŸŸ¢ ë¬¼ëŒì´</span>
                    ${turnTimes.map(t => `
                        <div style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:rgba(76,175,80,0.1);border-radius:6px;border-left:3px solid #4caf50;">
                            <span style="font-size:0.85em;color:var(--text);font-weight:600;">${t.time}</span>
                            <span style="font-size:0.72em;color:${t.type === 'ë“¤ë¬¼' ? '#4fc3f7' : '#ff8a65'};font-weight:600;">â†’${t.type}</span>
                        </div>
                    `).join('')}
                </div>` : ''}
            </div>`;
    }

    // ë¬¼ë•Œ ì¹´ë“œì— ì„ íƒëœ ì–´ì¢…ì˜ ë¬¼ë•Œ ê¸°ë°˜ ì„¤ëª… í‘œì‹œ
    function updateMulddaeSpeciesInfo() {
        const infoEl = document.getElementById('mulddaeSpeciesInfo');
        if (!infoEl) return;
        if (activeSpecies === 'none' || !SPECIES_CONFIG[activeSpecies]) {
            infoEl.style.display = 'none';
            return;
        }
        const cfg = SPECIES_CONFIG[activeSpecies];
        const mulddaeEl = document.getElementById('mulddaeInfo');
        if (!mulddaeEl) return;

        // í˜„ì¬ ë¬¼ë•Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const mulddae = getMulddaeInfo(getDateStr());
        // í†µí•© íŒì • í•¨ìˆ˜ ì‚¬ìš© â€” ì„ê³„ê°’ì€ SPECIES_RULESì—ì„œ í•œ ê³³ ê´€ë¦¬
        const speciesTips = {
            jjukkumi: {
                slackTip: 'â¸ï¸ ì •ì¡°: ì§ê²° ì±„ë¹„ + ìºìŠ¤íŒ… ë“œë˜ê¹…, ë°”ë‹¥ ê¸ì–´ ìœ ì¸',
                turnTip: 'ğŸŸ¢ ë¬¼ëŒì´: ê°€ì§€ì¤„ 20~30cm ì „í™˜, ë¦¬í”„íŠ¸&í´ ì•¡ì…˜',
                rigTip: 'ğŸ£ ì •ì¡°â†’ì§§ì€ ê°€ì§€ì¤„(10cm) | ìœ ì†â†’ê¸´ ê°€ì§€ì¤„(20~40cm)'
            },
            gapoh: {
                slackTip: 'â¸ï¸ ì •ì¡°: ì„­ì´í™œë™ ìœ ì§€ë˜ë‚˜ ì…ì§ˆê°ì§€ ê·¹ë‚œ â€” ì‰ì´í‚¹ í›„ 5~10ì´ˆ ìŠ¤í…Œì´',
                turnTip: 'ğŸŸ¢ ë¬¼ëŒì´ 15~30ë¶„ì´ ìŠ¹ë¶€! í­ë°œì  í”¼ë”©, ë¹ ë¥¸ í…œí¬ ê³µëµ',
                rigTip: 'ğŸ£ ì •ì¡°â†’ì§ê²° ì±„ë¹„+ìˆ˜í‰ ì—ê¸° | ìœ ì†â†’ì‹œì¸ì„± ë†’ì€ ë ˆì´ì € ì—ê¸°'
            },
            muneo: {
                slackTip: 'â¸ï¸ ì •ì¡°: ë¨¹ì´í™œë™ í”¼í¬! ë°”ìœ„í‹ˆ/ì€ì‹ ì²˜ ì£¼ë³€ ê³µëµ',
                turnTip: 'ğŸ”¥ ì´ˆë“¤ë¬¼(ê°„ì¡°â†’ë§Œì¡° ì „í™˜): í™©ê¸ˆì‹œê°„ â€” ë¨¹ì´ ë– ì˜¬ë¼ í™œë°œ',
                rigTip: 'ğŸ£ ë¬´ê±°ìš´ ë´‰ëŒë¡œ ë°”ë‹¥ ë°€ì°©, ì €ì† ë“œë˜ê¹…'
            }
        };

        const tips = speciesTips[activeSpecies];
        if (!tips) { infoEl.style.display = 'none'; return; }
        const suit = getSpeciesSuitability(activeSpecies, mulddae.pct, mulddae.num);

        infoEl.style.display = '';
        infoEl.innerHTML = `
            <div style="padding:10px 12px;background:${cfg.color}08;border:1px solid ${cfg.color}25;border-radius:10px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.3em;">${cfg.emoji}</span>
                    <span style="font-weight:700;color:${cfg.color};font-size:0.92em;">${cfg.name} Â· ì˜¤ëŠ˜ ${mulddae.num} (${mulddae.name} ${mulddae.pct}%)</span>
                </div>
                <div style="font-size:0.84em;color:var(--text);margin-bottom:8px;font-weight:500;">${suit.mulddaeDesc}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">
                    <div style="font-size:0.78em;color:var(--muted);padding:3px 0;border-top:1px solid ${cfg.color}15;">${tips.slackTip}</div>
                    <div style="font-size:0.78em;color:#ffa726;">${tips.turnTip}</div>
                    <div style="font-size:0.78em;color:var(--muted);">${tips.rigTip}</div>
                </div>
            </div>`;
    }

    function renderTideChart(labels, predicted, actual, baseAnnotations = {}) {
        const annotations = { ...baseAnnotations };
        const ctx = document.getElementById('tideChart').getContext('2d');
        if (tideChart) tideChart.destroy();
        if (labels.length === 0) { tideChart = null; return; }

        const grad1 = ctx.createLinearGradient(0, 0, 0, 320);
        grad1.addColorStop(0, 'rgba(79,195,247,0.3)');
        grad1.addColorStop(1, 'rgba(79,195,247,0.02)');

        const datasets = [{
            label: 'ì˜ˆì¸¡ ì¡°ìœ„ (cm)',
            data: predicted,
            borderColor: '#4fc3f7',
            backgroundColor: grad1,
            borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5,
        }];

        if (actual && actual.length > 0 && actual.some((v, i) => v !== predicted[i])) {
            datasets.push({
                label: 'ì‹¤ì¸¡ ì¡°ìœ„ (cm)',
                data: actual,
                borderColor: '#ffa726',
                borderWidth: 1.5, borderDash: [4, 4],
                fill: false, tension: 0.4, pointRadius: 0, pointHoverRadius: 5,
            });
        }

        const scales = {
            x: { ticks: { color: '#7a8ba3', maxTicksLimit: 24, font: { size: 10 }, callback: function(val, idx) { const lbl = this.getLabelForValue(val); return lbl && lbl.endsWith(':00') ? lbl : null; } }, grid: { color: 'rgba(255,255,255,0.04)' } },
            y: { grace: '8%', ticks: { color: '#7a8ba3', font: { size: 11 }, callback: v => v + ' cm' }, grid: { color: 'rgba(255,255,255,0.06)' } }
        };

        if (activeSpecies === 'gapoh' && predicted.length > 0) {
            const yMax = Math.max(...predicted.filter(v => v != null));
            const yMin = Math.min(...predicted.filter(v => v != null));
            const yCenter = (yMax + yMin) / 2;
            // ê¸°ì¡´ ê³ ì¡°/ì €ì¡° annotation(hl_) ìœ„ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const hlPoints = [];
            Object.keys(annotations).forEach(key => {
                if (key.match(/^hl_\d+$/) && annotations[key].xValue != null) {
                    hlPoints.push(annotations[key].xValue);
                }
            });
            hlPoints.sort((a, b) => a - b);

            // ê° ê³ ì¡°/ì €ì¡° ì¤‘ì‹¬ìœ¼ë¡œ ì •ì¡°(1h) + ë¬¼ëŒì´(1h) ë°°ì¹˜
            hlPoints.forEach((center, zc) => {
                const redStart = Math.max(0, center - SLACK_HALF);
                const redEnd = Math.min(labels.length - 1, center + SLACK_HALF);
                const turnStart = redEnd;
                const turnEnd = Math.min(labels.length - 1, redEnd + TURN_LEN);

                annotations['slack_zone_' + zc] = {
                    type: 'box', xMin: redStart, xMax: redEnd,
                    backgroundColor: 'rgba(255,82,82,0.07)',
                    borderColor: 'rgba(255,82,82,0.25)',
                    borderWidth: 1, borderDash: [3, 3],
                };
                annotations['slack_label_' + zc] = {
                    type: 'label', xValue: (redStart + redEnd) / 2, yValue: yCenter,
                    content: ['â¸ ì •ì¡°', labels[redStart] || '', '~', labels[redEnd] || ''], color: '#ff5252',
                    font: { size: 10, weight: 'bold' },
                    backgroundColor: 'rgba(17,29,53,0.85)',
                    padding: { top: 3, bottom: 3, left: 6, right: 6 }, borderRadius: 4,
                };
                annotations['turn_zone_' + zc] = {
                    type: 'box', xMin: turnStart, xMax: turnEnd,
                    backgroundColor: 'rgba(76,175,80,0.08)',
                    borderColor: 'rgba(76,175,80,0.3)',
                    borderWidth: 1, borderDash: [3, 3],
                };
                annotations['turn_label_' + zc] = {
                    type: 'label', xValue: (turnStart + turnEnd) / 2, yValue: yCenter,
                    content: ['ğŸŸ¢ ë¬¼ëŒì´', labels[turnStart] || '', '~', labels[turnEnd] || ''], color: '#4caf50',
                    font: { size: 10, weight: 'bold' },
                    backgroundColor: 'rgba(17,29,53,0.85)',
                    padding: { top: 3, bottom: 3, left: 6, right: 6 }, borderRadius: 4,
                };
            });
        }

        tideChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: { right: 15 } },
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: datasets.length > 1, labels: { color: '#7a8ba3', font: { size: 11 } } },
                    tooltip: {
                        backgroundColor: 'rgba(17,29,53,0.95)', titleColor: '#4fc3f7',
                        bodyColor: '#e0e6ed', borderColor: '#1e3a5f', borderWidth: 1, padding: 12,
                        callbacks: {
                            label: c => `${c.dataset.label}: ${c.parsed.y.toFixed(1)} cm`
                        }
                    },
                    annotation: { clip: false, annotations }
                },
                scales
            }
        });

        // ì‹œê°„ëŒ€ ì •ë³´ ì—…ë°ì´íŠ¸ (ì°¨íŠ¸ ìœ„ speciesLegend)
        updateSpeciesTimeRanges();
        updateMulddaeSpeciesInfo();
    }

    // ==================== 3) ì¡°ë¥˜ (crntFcstTime ì‹œê³„ì—´) ====================
    async function fetchCurrentData() {
        const infoEl = document.getElementById('currentInfo');
        const cStation = getCurrentStation();
        if (!cStation) {
            infoEl.innerHTML = '<div class="error-msg">ì´ ì§€ì—­ì—ëŠ” ì¡°ë¥˜ ì˜ˆë³´ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            renderCurrentChart([]);
            return;
        }
        infoEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>ì¡°ë¥˜ ë°ì´í„° ë¡œë”©...</div></div>';

        try {
            const items = await apiCall('crntFcstTime/GetCrntFcstTimeApiService', {
                obsCode: cStation,
                reqDate: getDateStr(),
                numOfRows: '300',
                pageNo: '1'
            });

            if (!items || items.length === 0) {
                infoEl.innerHTML = '<div class="error-msg">ì¡°ë¥˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ˆë³´ì ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                renderCurrentChart([]); return;
            }

            const filtered = items.filter((_, idx) => idx % 10 === 0);
            renderCurrentTable(filtered, infoEl);
            renderCurrentChart(filtered);
        } catch(e) {
            infoEl.innerHTML = `<div class="error-msg">ì¡°ë¥˜ ì˜¤ë¥˜: ${e.message}</div>`;
            renderCurrentChart([]);
        }
    }

    function getSpeedColor(speed) {
        const s = parseFloat(speed);
        if (s >= 100) return '#ff6b6b';
        if (s >= 50) return '#ffa726';
        if (s >= 20) return '#4fc3f7';
        return '#4ecdc4';
    }

    function renderCurrentTable(items, el) {
        const maxSpeed = Math.max(...items.map(i => parseFloat(i.crsp) || 0), 1);

        el.innerHTML = `
            <div style="margin-bottom:10px;font-size:0.82em;color:var(--muted);">
                ì˜ˆë³´ì : <strong style="color:var(--text)">${items[0]?.obsvtrNm || '-'}</strong> Â·
                ì´ ${items.length}ê±´ (10ë¶„ ê°„ê²©)
            </div>
            <div style="max-height:400px;overflow-y:auto;">
            <table class="current-table">
                <thead><tr><th>ì‹œê°„</th><th>ìœ í–¥</th><th>ìœ ì† (cm/s)</th><th>ì„¸ê¸°</th></tr></thead>
                <tbody>
                    ${items.map(item => {
                        const time = item.predcDt ? item.predcDt.substring(11, 16) : '-';
                        const speed = parseFloat(item.crsp) || 0;
                        const pct = (speed / maxSpeed) * 100;
                        const color = getSpeedColor(speed);
                        return `<tr>
                            <td>${time}</td>
                            <td style="color:${color};">${item.crdir || '-'}</td>
                            <td>${speed.toFixed(1)}</td>
                            <td style="min-width:100px;"><div class="speed-bar"><div class="speed-bar-fill" style="width:${pct}%;background:${color};"></div></div></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
            </div>`;
    }

    function renderCurrentChart(items) {
        const ctx = document.getElementById('currentChart').getContext('2d');
        if (currentChart) currentChart.destroy();
        if (!items || items.length === 0) { currentChart = null; return; }

        const labels = items.map(i => i.predcDt ? i.predcDt.substring(11, 16) : '-');
        const speeds = items.map(i => parseFloat(i.crsp) || 0);

        const gradient = ctx.createLinearGradient(0, 0, 0, 320);
        gradient.addColorStop(0, 'rgba(0,229,255,0.3)');
        gradient.addColorStop(1, 'rgba(0,229,255,0.02)');

        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'ìœ ì† (cm/s)', data: speeds,
                    borderColor: '#00e5ff', backgroundColor: gradient,
                    borderWidth: 2, fill: true, tension: 0.4,
                    pointRadius: 0, pointHoverRadius: 5,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17,29,53,0.95)', titleColor: '#00e5ff',
                        bodyColor: '#e0e6ed', borderColor: '#1e3a5f', borderWidth: 1, padding: 12,
                        callbacks: { label: c => `ìœ ì†: ${c.parsed.y.toFixed(1)} cm/s` }
                    }
                },
                scales: {
                    x: { ticks: { color: '#7a8ba3', maxTicksLimit: 12, font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#7a8ba3', font: { size: 11 }, callback: v => v + ' cm/s' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                }
            }
        });
    }
    </script>
</body>
</html>
