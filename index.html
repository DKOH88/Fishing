<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¼ë•Œ & ì¡°ë¥˜ ì •ë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --bg: #0a1628;
            --card: #111d35;
            --border: #1e3a5f;
            --primary: #4fc3f7;
            --accent: #00e5ff;
            --high: #ff6b6b;
            --low: #4ecdc4;
            --text: #e0e6ed;
            --muted: #7a8ba3;
            --warn: #ffa726;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 960px; margin: 0 auto; padding: 16px; }
        header { text-align: center; padding: 20px 0 12px; }
        header h1 { font-size: 1.6em; color: var(--accent); display: flex; align-items: center; justify-content: center; gap: 10px; }
        header h1 .wave { font-size: 1.3em; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; align-items: flex-end; }
        .control-group { flex: 1; min-width: 140px; }
        .control-group label { display: block; font-size: 0.78em; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input[type="date"] { width: 100%; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95em; outline: none; cursor: pointer; }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,195,247,0.2); }
        .btn { padding: 10px 24px; background: linear-gradient(135deg, #1a73e8, #4fc3f7); border: none; border-radius: 8px; color: #fff; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79,195,247,0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card-title { font-size: 1em; color: var(--primary); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .tide-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .tide-item { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .tide-item.high { border-left: 3px solid var(--high); }
        .tide-item.low { border-left: 3px solid var(--low); }
        .tide-item.diff { border-left: 3px solid var(--warn); }
        .tide-item .label { font-size: 0.75em; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .tide-item .value { font-size: 1.8em; font-weight: 700; margin: 4px 0; }
        .tide-item.high .value { color: var(--high); }
        .tide-item.low .value { color: var(--low); }
        .tide-item.diff .value { color: var(--warn); }
        .tide-item .time { font-size: 0.82em; color: var(--muted); }
        .chart-container { position: relative; height: 320px; }
        .current-table { width: 100%; border-collapse: collapse; }
        .current-table th { text-align: left; padding: 8px 12px; font-size: 0.78em; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .current-table td { padding: 10px 12px; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .speed-bar { height: 6px; border-radius: 3px; background: var(--border); overflow: hidden; margin-top: 4px; }
        .speed-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
        .loading { text-align: center; padding: 40px; color: var(--muted); }
        .loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--high); text-align: center; padding: 20px; font-size: 0.9em; }
        .tide-detail-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tide-tag { padding: 6px 14px; border-radius: 20px; font-size: 0.82em; font-weight: 500; }
        .tide-tag.high { background: rgba(255,107,107,0.15); color: var(--high); }
        .tide-tag.low { background: rgba(78,205,196,0.15); color: var(--low); }
        footer { text-align: center; padding: 20px; color: var(--muted); font-size: 0.75em; }
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
        .tab-btn { padding: 10px 20px; background: transparent; border: none; color: var(--muted); font-size: 0.9em; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:hover { color: var(--text); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ê²€ìƒ‰ ë°” */
        .search-bar { position: relative; margin-bottom: 16px; }
        .search-bar input { width: 100%; padding: 12px 16px 12px 40px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 0.95em; outline: none; }
        .search-bar input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,195,247,0.2); }
        .search-bar .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 1em; color: var(--muted); pointer-events: none; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: 10px; max-height: 320px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.4); margin-top: 4px; }
        .search-results.show { display: block; }
        .search-result-item { padding: 10px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .search-result-item:hover { background: rgba(79,195,247,0.1); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item .name { color: var(--text); font-size: 0.9em; }
        .search-result-item .name em { color: var(--accent); font-style: normal; font-weight: 600; }
        .search-result-item .tags { display: flex; gap: 4px; }
        .search-result-item .tag { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500; }
        .search-result-item .tag.obs { background: rgba(79,195,247,0.15); color: var(--primary); }
        .search-result-item .tag.crnt { background: rgba(0,229,255,0.15); color: var(--accent); }
        .search-result-item .tag.region { background: rgba(255,167,38,0.15); color: var(--warn); }
        .search-no-result { padding: 16px; text-align: center; color: var(--muted); font-size: 0.85em; }
        .region-badge { display: inline-block; padding: 2px 10px; border-radius: 10px; font-size: 0.72em; background: rgba(79,195,247,0.12); color: var(--primary); margin-left: 8px; vertical-align: middle; }

        /* ì¢Œí‘œ ì¡°ë¥˜ ì»¨íŠ¸ë¡¤ */
        .coord-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; align-items: flex-end; }
        .coord-controls .control-group { flex: 1; min-width: 120px; }
        .coord-controls input[type="number"] { width: 100%; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95em; outline: none; }
        .coord-controls input[type="number"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,195,247,0.2); }
        .port-badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 0.72em; background: rgba(0,229,255,0.12); color: var(--accent); margin-left: 6px; }

        @media (max-width: 600px) {
            .controls { flex-direction: column; }
            .control-group { min-width: 100%; }
            .chart-container { height: 250px; }
            .tide-summary { grid-template-columns: 1fr 1fr; }
            header h1 { font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="wave">ğŸŒŠ</span> ë¬¼ë•Œ & ì¡°ë¥˜ ì •ë³´</h1>
        </header>

        <!-- ê²€ìƒ‰ -->
        <div class="search-bar" id="searchBar">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="ì§€ì—­ëª… ê²€ìƒ‰ (ì˜ˆ: ì¸ì²œ, ë¶€ì‚°í•­, í•´ìš´ëŒ€, ì—¬ìˆ˜í•´í˜‘...)" autocomplete="off" />
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label>ê´€ì¸¡ì†Œ (ì¡°ìœ„) <span class="region-badge" id="stationRegion">ì¸ì²œ/ê²½ê¸°</span></label>
                <select id="stationSelect"></select>
            </div>
            <div class="control-group">
                <label>ì¡°ë¥˜ ì˜ˆë³´ì  <span class="region-badge" id="currentRegion">ì¸ì²œ/ê²½ê¸°</span></label>
                <select id="currentSelect"></select>
            </div>
            <div class="control-group">
                <label>ë‚ ì§œ</label>
                <input type="date" id="dateInput" />
            </div>
            <div class="control-group" style="flex:0;">
                <label>&nbsp;</label>
                <button class="btn" id="searchBtn" onclick="fetchAll()">ì¡°íšŒ</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="tide">ë¬¼ë•Œ/ì¡°ìœ„</button>
            <button class="tab-btn" data-tab="current">ì¡°ë¥˜</button>
            <button class="tab-btn" data-tab="coord-current">ğŸ“ ë‚šì‹œí¬ì¸íŠ¸</button>
        </div>

        <!-- Tide Tab -->
        <div class="tab-content active" id="tab-tide">
            <div class="card" id="tideSummaryCard">
                <div class="card-title">ğŸ“Š ê³ ì €ì¡° ìš”ì•½</div>
                <div id="tideSummary"><div style="text-align:center;color:var(--muted);padding:20px;">ê´€ì¸¡ì†Œì™€ ë‚ ì§œë¥¼ ì„ íƒ í›„ ì¡°íšŒí•˜ì„¸ìš”</div></div>
            </div>
            <div class="card" id="tideDetailCard">
                <div class="card-title">ğŸ“‹ ê³ ì €ì¡° ìƒì„¸</div>
                <div id="tideDetail"></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“ˆ ì¡°ìœ„ ë³€í™” ê·¸ë˜í”„ (10ë¶„ ë‹¨ìœ„)</div>
                <div class="chart-container"><canvas id="tideChart"></canvas></div>
            </div>
        </div>

        <!-- Current Tab -->
        <div class="tab-content" id="tab-current">
            <div class="card">
                <div class="card-title">ğŸŒ€ ì¡°ë¥˜ ì •ë³´ (ìœ í–¥/ìœ ì†)</div>
                <div id="currentInfo"><div style="text-align:center;color:var(--muted);padding:20px;">ì¡°ë¥˜ ì˜ˆë³´ì ê³¼ ë‚ ì§œë¥¼ ì„ íƒ í›„ ì¡°íšŒí•˜ì„¸ìš”</div></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“ˆ ì¡°ë¥˜ ìœ ì† ê·¸ë˜í”„</div>
                <div class="chart-container"><canvas id="currentChart"></canvas></div>
            </div>
        </div>

        <!-- Fishing Port Tab -->
        <div class="tab-content" id="tab-coord-current">
            <div class="card">
                <div class="card-title">ğŸ“ ë‚šì‹œ í¬ì¸íŠ¸ ì¡°íšŒ</div>
                <div class="coord-controls">
                    <div class="control-group" style="flex:2; min-width:200px;">
                        <label>ë‚šì‹œ í¬ì¸íŠ¸ <span class="port-badge" id="portRegion">ì„ íƒ</span></label>
                        <select id="fishingPortSelect" onchange="onFishingPortChange()">
                            <option value="">ë‚šì‹œ í¬ì¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="control-group" style="flex:0;">
                        <label>&nbsp;</label>
                        <button class="btn" id="coordSearchBtn" onclick="fetchPortData()">ì¡°íšŒ</button>
                    </div>
                </div>
                <div id="portMapping" style="font-size:0.82em;color:var(--muted);margin-top:-8px;margin-bottom:4px;"></div>
            </div>
            <!-- ê³ ì €ì¡° ìš”ì•½ -->
            <div class="card" id="portTideSummaryCard" style="display:none;">
                <div class="card-title">ğŸ“Š ê³ ì €ì¡° ìš”ì•½ <span id="portTideStation" class="port-badge"></span></div>
                <div id="portTideSummary"></div>
            </div>
            <!-- ì¡°ìœ„ ê·¸ë˜í”„ -->
            <div class="card" id="portTideChartCard" style="display:none;">
                <div class="card-title">ğŸ“ˆ ì¡°ìœ„ ë³€í™” ê·¸ë˜í”„</div>
                <div class="chart-container"><canvas id="portTideChart"></canvas></div>
            </div>
            <!-- ì¡°ë¥˜ í…Œì´ë¸” -->
            <div class="card" id="portCurrentCard" style="display:none;">
                <div class="card-title">ğŸŒ€ ì¡°ë¥˜ ì •ë³´ <span id="portCurrentStation" class="port-badge"></span></div>
                <div id="portCurrentInfo"></div>
            </div>
            <!-- ì¡°ë¥˜ ê·¸ë˜í”„ -->
            <div class="card" id="portCurrentChartCard" style="display:none;">
                <div class="card-title">ğŸ“ˆ ì¡°ë¥˜ ìœ ì† ê·¸ë˜í”„</div>
                <div class="chart-container"><canvas id="portCurrentChart"></canvas></div>
            </div>
        </div>

        <footer>
            ë°ì´í„° ì¶œì²˜: êµ­ë¦½í•´ì–‘ì¡°ì‚¬ì› (ê³µê³µë°ì´í„°í¬í„¸ / KHOA í•´ì–‘ì •ë³´)<br>
            â€» ì˜ˆì¸¡ ë°ì´í„°ì´ë©°, ì‹¤ì œ ê°’ê³¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </footer>
    </div>

    <script>
    // ==================== CONFIG ====================
    const API_BASE = 'https://tide-api-proxy.odk297.workers.dev';
    let tideChart = null;
    let currentChart = null;

    // ==================== ì§€ì—­ ë°ì´í„° (ê´€ì¸¡ì†Œ + ì¡°ë¥˜ ì˜ˆë³´ì  í†µí•©) ====================
    const REGIONS = [
        {
            key: 'incheon', label: 'ì¸ì²œ/ê²½ê¸°',
            stations: [
                ['DT_0001','ì¸ì²œ'],['DT_0052','ì¸ì²œì†¡ë„'],['DT_0044','ì˜ì¢…ëŒ€êµ'],['DT_0032','ê°•í™”ëŒ€êµ'],
                ['DT_0043','ì˜í¥ë„'],['DT_0093','ì†Œë¬´ì˜ë„'],['DT_0065','ë•ì ë„'],['DT_0066','í–¥í™”ë„'],
                ['DT_0002','í‰íƒ'],['DT_0008','ì•ˆì‚°']
            ],
            currents: [
                ['07GG03','ì„ëª¨ìˆ˜ë„'],['07GG06','ì¸ì²œê°‘ë¬¸'],['07GG11','ë•ì ë„'],['09IC01','ì¸ì²œë‚¨í•­'],
                ['09IC07','ê²½ì¸ì•„ë¼ë±ƒê¸¸'],['14IC03','ìì›”ë„ë¶ì¸¡'],['14IC04','ì´ì‘ë„ì„œì¸¡'],['16LTC01','ì¸ì²œëŒ€êµ'],
                ['16LTC02','ì¸ì²œë™ìˆ˜ë„ì…êµ¬'],['16DJ04','ì‹œí™”ë°©ì¡°ì œ'],['17LTC01','ì¸ì²œì‹ í•­ì…êµ¬'],['17LTC02','ê²½ê¸°ë§Œë¶ìˆ˜ë„'],
                ['19LTC01','í™”ì„±ë°©ì¡°ì œ'],['20LTC04','ì˜í¥ë„ì„œì¸¡'],['20LTC07','ìì›”ë„ë¶ì„œì¸¡'],['20LTC11','ë•ì êµ°ë„ì„œì¸¡'],
                ['20LTC12','ìˆ˜ìš°ë„ì„œì¸¡'],['05GH-5','ì¥ë´‰ìˆ˜ë„'],['15LTC01','ì—¼í•˜ìˆ˜ë„'],['03DS-1','ì¥ì•ˆì„œ']
            ]
        },
        {
            key: 'west_mid', label: 'ì¶©ë‚¨/ì „ë¶ (ì„œí•´ì¤‘ë¶€)',
            stations: [
                ['DT_0050','íƒœì•ˆ'],['DT_0067','ì•ˆí¥'],['DT_0017','ëŒ€ì‚°'],['DT_0025','ë³´ë ¹'],
                ['DT_0051','ì„œì²œë§ˆëŸ‰'],['DT_0024','ì¥í•­'],['DT_0018','êµ°ì‚°'],['DT_0068','ìœ„ë„'],['DT_0037','ì–´ì²­ë„']
            ],
            currents: [
                ['03PT-1','ì•„ì‚°ë§Œì…êµ¬'],['07DS02','ëŒ€ì‚°í•­'],['07TA03','íƒœì•ˆ'],['07TA04','ë§Œë¦¬í¬'],
                ['07TA05','ì•ˆí¥'],['07TA09','ê²©ë ¬ë¹„ì—´ë„'],['07KS01','ì›ì‚°ë„'],['07KS03','ì™¸ì—°ì—´ë„'],
                ['12JB11','ë¹„ì¸ë§Œ'],['12JB14','êµ°ì‚°í•­ì…êµ¬'],['13PT01','í‰íƒí•­'],['15LTC08','ì¥ê³ ë„ìˆ˜ë„'],
                ['16LTC03','ì²œìˆ˜ë§Œ'],['17LTC04','ë¬¸ê°‘ë„ë™ì¸¡'],['17LTC06','ê°€ë¡œë¦¼ë§Œì…êµ¬'],['19LTC02','ì™¸ì—°ë„ë™ì¸¡'],
                ['23GA01','ì•ˆë©´ë„ì„œì¸¡'],['24TJ02','ê°€ë¡œë¦¼ë§Œ'],['24TJ04','ì…íŒŒë„'],['24TJ05','ì•„ì‚°ë§Œ28í˜¸ë“±ë¶€í‘œ']
            ]
        },
        {
            key: 'west_south', label: 'ì „ë‚¨ì„œë¶€ (ëª©í¬/ì‹ ì•ˆ)',
            stations: [
                ['DT_0007','ëª©í¬'],['DT_0035','í‘ì‚°ë„'],['DT_0094','ì„œê±°ì°¨ë„']
            ],
            currents: [
                ['01MP-2','ëª©í¬êµ¬'],['06SA01','ë©´ë„ìˆ˜ë„'],['06SA10','íŒ”êµ¬í¬ë¶ì¸¡'],['06SA18','ê²½ì¹˜ë™ìˆ˜ë„'],
                ['06GS07','ê³ êµ°ì‚°êµ°ë„'],['07JB12','ìˆ˜ë„ìˆ˜ë„ë¶ì¸¡'],['07JB14','ìˆ˜ë„ìˆ˜ë„'],['10MP07','ì‹œì•„í•´'],
                ['14BP01','ë³‘í’ë„ë¶ì¸¡'],['15LTC02','ì–´ì²­ë„ì„œì¸¡'],['15LTC03','ìœ„ë„ë™ì¸¡'],['16LTC05','ëª©í¬ë¶í•­ë¶ì¸¡'],
                ['16LTC06','ì‹œì•„í•´ë¶ì¸¡'],['17LTC08','ë…¹ë„ë¶ì¸¡'],['17LTC09','ì‹­ì´ë™íŒŒë„'],['17LTC10','ê³ êµ°ì‚°êµ°ë„ë¶ì¸¡'],
                ['17MTC14','ìœ„ë„ì„œì¸¡'],['17MTC19','ì•ˆë§ˆë„ì„œì¸¡'],['17MTC20','ì•ˆë§ˆë„ë™ì¸¡'],['18LTC01','ë‚œì§€ë„ë¶ì¸¡'],
                ['18LTC02','ì™€ë„ì„œì¸¡'],['18LTC03','ì•ˆì¢Œë„ë¶ì¸¡'],['18LTC04','ë¹„ê¸ˆìˆ˜ë„'],['19LTC03','ì¬ì›ë™ìˆ˜ë„'],
                ['19LTC04','ì¦ë„ë™ì¸¡'],['19LTC05','ë§¤í™”ë„ì„œì¸¡'],['19LTC06','í•˜ì˜ìˆ˜ë„'],['20LTC01','ì–´ë¶ˆë„ì„œì¸¡'],
                ['20LTC02','ë…ê±°êµ°ë„ë¶ì¸¡'],['20LTC03','ì™¸ëª¨êµ°ë„ë‚¨ì¸¡'],['20LTC05','í•¨í‰ë§Œì…êµ¬'],['20LTC08','ìš°ì´ìˆ˜ë„'],
                ['20LTC09','ì†¡ì´ë„ë¶ì¸¡'],['22LTC12','ë§ˆëŸ‰í•­'],['22EW01','ëŒ€í™”ì‚¬ë„ì„œì¸¡'],['23LTC05','ìœ¨ë„ë¶ë™ì¸¡'],
                ['23LTC06','ëŒ€ì•¼ë„ë™ì¸¡'],['23LTC07','ìš°ì´ë„ë‚¨ì¸¡'],['23LTC08','ì¥ì‚°ë„ì„œì¸¡'],['23LTC09','ë‹¬ë¦¬ë„ì„œì¸¡'],
                ['24LTC01','ì¬ì›ë„ë‚¨ì„œì¸¡'],['24LTC02','ì–´ì˜ë„ë¶ì¸¡'],['24LTC03','ì•ˆë§ˆë„ë‚¨ì¸¡'],['24LTC04','ê±°ë¥œë„ë‚¨ì„œì¸¡'],
                ['24LTC05','ë§ë„ë‚¨ì¸¡'],['24LTC06','ì†Œíš¡ê²½ë„ë¶ì¸¡'],['24LTC07','ì‹­ì´ë™íŒŒë„ë‚¨ë™ì¸¡'],['24LTC08','ëŒ€í™”ì‚¬ë„ë‚¨ì¸¡'],
                ['24LTC09','ì‚½ì‹œë„ë¶ì¸¡'],['24LTC10','ì™¸íŒŒìˆ˜ë„ë‚¨ì¸¡'],['24LTC11','ê°€ì˜ë„ë¶ë™ì¸¡']
            ]
        },
        {
            key: 'south_west', label: 'ì „ë‚¨ë™ë¶€ (ì§„ë„/ì™„ë„/ì—¬ìˆ˜)',
            stations: [
                ['DT_0028','ì§„ë„'],['DT_0027','ì™„ë„'],['DT_0026','ê³ í¥ë°œí¬'],['DT_0092','ì—¬í˜¸í•­'],
                ['DT_0016','ì—¬ìˆ˜'],['DT_0049','ê´‘ì–‘'],['DT_0031','ê±°ë¬¸ë„']
            ],
            currents: [
                ['06JD01','ì™¸ë³‘ë„'],['06GH01','ë“ëŸ‰ë§Œì…êµ¬'],['06GH07','ê±°ê¸ˆë„ë‚¨ì¸¡'],['06YME1','ê´‘ë„ë™ì¸¡'],
                ['06YME4','ë³´ê¸¸ë„ë‚¨ì„œì¸¡'],['06YME5','ì¥ì£½ìˆ˜ë„'],['06YME6','ë§¹ê³¨ìˆ˜ë„'],['06YME8','ë§¤ë¬¼ìˆ˜ë„'],
                ['06YS03','ì‹ ê°•ìˆ˜ë„'],['06YS04','ì„œìˆ˜ë„(ì—¬ìë§Œ)'],['06YS09','ê±°ê¸ˆìˆ˜ë„'],['08GY-5','ë¬˜ë„ìˆ˜ë„'],
                ['11JD02','ì •ë“±í•´'],['11JD09','ë§ˆë¡œí•´'],['12YS08','ê´‘ì–‘í•­'],['13WD01','ì†Œì•ˆë„'],
                ['14JD03','ì •ë“±í•´ë¶ì¸¡'],['15LTC05','ë§Œì¬ë„ì„œì¸¡'],['15LTC06','ê±°ì°¨ìˆ˜ë„'],['15LTC07','ë…ê±°êµ°ë„ë™ì¸¡'],
                ['15LTC09','ê¸ˆë‹¹ìˆ˜ë„'],['15LTC10','ì—¬ìˆ˜í•´ë§Œ'],['15SE01','ë…¸ëŸ‰ìˆ˜ë„'],['15HD05','í•˜ë™í•­'],
                ['16LTC04','ì—­ë„'],['16LTC07','ì¥ì‚°ë„ë™ì¸¡'],['16LTC08','ê´‘ì–‘í•­ì œ1í•­ë¡œ'],['16LTC12','ë‚™ë™í¬'],
                ['17LTC11','ê°€ì‚¬ë„ë™ì¸¡'],['17LTC12','ì†Œì•ˆìˆ˜ë„'],['17LTC13','ì™„ë„í†µí•­ë¶„ë¦¬ëŒ€'],['18LTC05','í‘ì¼ë„ë‚¨ì¸¡'],
                ['18LTC06','ì—¬ìˆ˜í•´í˜‘'],['18LTC07','ì—¬ìˆ˜í•´ë§Œì…êµ¬'],['18MTC10','ì´ˆë„ë‚¨ì¸¡'],['19LTC07','ì²­ì‚°ë„ë™ì¸¡'],
                ['19LTC08','ëŒ€ë³‘í’ë„ì„œì¸¡'],['19LTC09','ì´ˆë„ë™ì¸¡'],['19LTC10','ì†ì£½ë„ë¶ì¸¡'],['19LTC11','ë‚˜ë¡œë„ë™ì¸¡'],
                ['19LTC12','ì—¬ìˆ˜í•´ë§Œë‚¨ì¸¡'],['19LTC13','ëŒ€ë³‘ëŒ€ë„ë™ì¸¡'],['20LTC06','ê¸ˆì˜¤ì—´ë„ë‚¨ì¸¡'],['20LTC13','ê´€ë¦¬ë„'],
                ['20LTC14','ê°€ë•ë„ë‚¨ì¸¡'],['20LTC15','ê±°ê¸ˆë„ë™ì¸¡'],['22LTC01','ì‚¼ì²œí¬-ì œì£¼í•­ë¡œ'],['22LTC02','ëŒ€ë°©ìˆ˜ë„'],
                ['22LTC03','ë…¸ëŸ‰ìˆ˜ë„ë™ì¸¡'],['22LTC04','ì™¸ìˆ˜ë„'],['22LTC05','ê¸ˆì˜¤ìˆ˜ë„'],['22LTC06','ë°±ì•¼ë„ë™ì¸¡'],
                ['22LTC07','ë°±ì•¼ìˆ˜ë„'],['22LTC08','ì™¸ë‚˜ë¡œë„ì„œì¸¡'],['22LTC09','ì†ì£½ë„ì„œì¸¡'],['22LTC10','ì†Œë¡ë„ë™ì¸¡'],
                ['22LTC13','ì²­ì‚°ë„ì„œì¸¡'],['22LTC14','í™©ì œë„ë™ì¸¡'],['22LTC15','ê´‘ì–‘í•­Aí˜¸ë“±ë¶€í‘œ'],
                ['23LTC01','ìš°ë„ë¶ì„œì¸¡'],['23LTC02','ì œì£¼ë„ì„œì¸¡'],['23LTC03','ë°±ì¼ë„ë™ì¸¡'],['23LTC04','ì–´ë£¡ë„ë¶ì¸¡'],
                ['23YG03','ì™¸ë‚˜ë¡œë„ë‚¨ì¸¡']
            ]
        },
        {
            key: 'south_east', label: 'ê²½ë‚¨ (í†µì˜/ê±°ì œ/ë¶€ì‚°)',
            stations: [
                ['DT_0061','ì‚¼ì²œí¬'],['DT_0014','í†µì˜'],['DT_0029','ê±°ì œë„'],['DT_0063','ê°€ë•ë„'],
                ['DT_0062','ë§ˆì‚°'],['DT_0056','ë¶€ì‚°í•­ì‹ í•­'],['DT_0005','ë¶€ì‚°']
            ],
            currents: [
                ['01SR-1','ì‚¬ëŸ‰ë„ë¶ì¸¡'],['08GA01','ê°ì²œí•­ì…êµ¬'],['10GD03','ê°€ë•ìˆ˜ë„'],['16LTC09','í†µì˜í•´ë§Œ'],
                ['16LTC10','ë¹„ì§„ë„ë‚¨ì¸¡'],['16LTC13','ë¶€ì‚°í•­ì…êµ¬'],['16MTC01','ë¯¸ì¡°ìˆ˜ë„'],['16MTC16','ì§€ì‹¬ë„ì„œì¸¡'],
                ['17LTC14','ìš•ì§€ë„ë¶ì¸¡'],['18LTC08','ë‘ë¯¸ë„ë¶ì¸¡'],['18LTC09','ì‚¬ëŸ‰ë„ë™ì¸¡'],['18LTC10','ê°€ì¡°ë„ìˆ˜ë„'],
                ['18LTC11','ì§„í•´ë§Œ(í†µì˜í•­ë¡œ)'],['18LTC12','ê±°ì œë„ë™ì¸¡'],['18LTC13','í•´ìš´ëŒ€'],['19LTC14','ê´‘ì•ˆë¦¬'],
                ['21LTC01','íƒœì¢…ëŒ€ë‚¨ì¸¡'],['21LTC02','ë¶í˜•ì œë„ë‚¨ì¸¡'],['21LTC03','ê°€ë•ë„ë‚¨ì„œì¸¡'],['21LTC04','ë¶€ì‚°í•­ì‹ í•­'],
                ['21LTC05','ì €ë„ì„œì¸¡'],['21LTC06','ë‚´ë„ë™ì¸¡'],['21LTC07','ì¹ ì²œë„ë¶ì„œì¸¡'],['21LTC08','ì¥ì‚¬ë„ë¶ì¸¡'],
                ['21LTC09','ìš©ì´ˆë„ë¶ì¸¡'],['21LTC10','ê²¬ë‚´ëŸ‰í•´í˜‘'],['21LTC11','ì˜¤ê³¡ë„ë¶ì¸¡'],['21LTC12','ê³¤ë¦¬ë„ë‚¨ì¸¡'],
                ['21LTC13','ì‚¬ëŸ‰ë„ë¶ë™ì¸¡'],['21LTC14','ì‹ ìˆ˜ë„ë™ì¸¡'],['98HG-1','íš¡ê°„ìˆ˜ë„']
            ]
        },
        {
            key: 'east', label: 'ë™í•´',
            stations: [
                ['DT_0020','ìš¸ì‚°'],['DT_0091','í¬í•­'],['DT_0039','ì™•ëŒì´ˆ'],['DT_0011','í›„í¬'],
                ['DT_0057','ë™í•´í•­'],['DT_0006','ë¬µí˜¸'],['DT_0012','ì†ì´ˆ'],['DT_0013','ìš¸ë¦‰ë„']
            ],
            currents: [
                ['16LTC14','ìš¸ì‚°ì‹ í•­'],['17LTC05','ìš¸ë„'],['17LTC07','ìš¸ë„ë‚¨ì¸¡'],['18LTC14','ëŒ€ì™•ì•”ë‚¨ì¸¡']
            ]
        },
        {
            key: 'jeju', label: 'ì œì£¼',
            stations: [
                ['DT_0004','ì œì£¼'],['DT_0022','ì„±ì‚°í¬'],['DT_0010','ì„œê·€í¬'],['DT_0023','ëª¨ìŠ¬í¬'],['DT_0021','ì¶”ìë„']
            ],
            currents: [
                ['02JJ-1','ì œì£¼í•­'],['08JJ03','ì„±ì‚°í¬'],['08JJ07','ì„œê·€í¬'],['08JJ13','ì• ì›”í•­ë¶ì¸¡'],
                ['08F','ì¶”ìë„ë‚¨ì„œì¸¡'],['10ED01','ì´ì–´ë„'],['22MTC03','ì œì£¼í•´í˜‘']
            ]
        },
        {
            key: 'ocean_base', label: 'í•´ì–‘ê³¼í•™ê¸°ì§€',
            stations: [
                ['DT_0042','êµë³¸ì´ˆ'],['IE_0060','ì´ì–´ë„'],['IE_0061','ì‹ ì•ˆê°€ê±°ì´ˆ'],['IE_0062','ì˜¹ì§„ì†Œì²­ì´ˆ']
            ],
            currents: []
        }
    ];

    // ==================== ë‚šì‹œ í¬ì¸íŠ¸ í”„ë¦¬ì…‹ (ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ/ì¡°ë¥˜ì˜ˆë³´ì  ë§¤í•‘) ====================
    const FISHING_PORTS = [
        { name: 'ì˜¤ì²œí•­', lat: 36.38, lon: 126.47, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '16LTC03', currentName: 'ì²œìˆ˜ë§Œ' },
        { name: 'ì‚¼ê¸¸í¬í•­', lat: 36.33, lon: 126.42, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '16LTC03', currentName: 'ì²œìˆ˜ë§Œ' },
        { name: 'ëŒ€ì²œí•­', lat: 36.32, lon: 126.51, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '07KS01', currentName: 'ì›ì‚°ë„' },
        { name: 'í™ì›í•­', lat: 36.30, lon: 126.48, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '07KS01', currentName: 'ì›ì‚°ë„' },
        { name: 'ë¬´ì°½í¬', lat: 36.27, lon: 126.54, region: 'ì¶©ë‚¨', station: 'DT_0025', stationName: 'ë³´ë ¹', current: '07KS01', currentName: 'ì›ì‚°ë„' },
        { name: 'ì•ˆí¥ì™¸í•­', lat: 36.67, lon: 126.13, region: 'ì¶©ë‚¨', station: 'DT_0067', stationName: 'ì•ˆí¥', current: '07TA05', currentName: 'ì•ˆí¥' },
        { name: 'ê°„ì›”ë„', lat: 36.62, lon: 126.37, region: 'ì¶©ë‚¨', station: 'DT_0017', stationName: 'ëŒ€ì‚°', current: '17LTC06', currentName: 'ê°€ë¡œë¦¼ë§Œì…êµ¬' },
        { name: 'ê¶ë¦¬í¬êµ¬', lat: 36.78, lon: 126.12, region: 'ì¶©ë‚¨', station: 'DT_0050', stationName: 'íƒœì•ˆ', current: '07TA03', currentName: 'íƒœì•ˆ' },
        { name: 'ê²©í¬í•­', lat: 35.62, lon: 126.47, region: 'ì „ë¶', station: 'DT_0068', stationName: 'ìœ„ë„', current: '15LTC03', currentName: 'ìœ„ë„ë™ì¸¡' },
        { name: 'ë¶€ì•ˆë³€ì‚°', lat: 35.67, lon: 126.51, region: 'ì „ë¶', station: 'DT_0068', stationName: 'ìœ„ë„', current: '15LTC03', currentName: 'ìœ„ë„ë™ì¸¡' },
        { name: 'ë¹„ì‘í•­', lat: 35.97, lon: 126.62, region: 'ì „ë¶', station: 'DT_0018', stationName: 'êµ°ì‚°', current: '12JB14', currentName: 'êµ°ì‚°í•­ì…êµ¬' },
        { name: 'ì„ ìœ ë„', lat: 35.82, lon: 126.42, region: 'ì „ë¶', station: 'DT_0018', stationName: 'êµ°ì‚°', current: '06GS07', currentName: 'ê³ êµ°ì‚°êµ°ë„' },
        { name: 'ë…¹ë™í•­', lat: 34.48, lon: 127.08, region: 'ì „ë‚¨', station: 'DT_0026', stationName: 'ê³ í¥ë°œí¬', current: '06YS09', currentName: 'ê±°ê¸ˆìˆ˜ë„' },
        { name: 'ë§ˆëŸ‰í•­', lat: 34.38, lon: 126.38, region: 'ì „ë‚¨', station: 'DT_0007', stationName: 'ëª©í¬', current: '22LTC12', currentName: 'ë§ˆëŸ‰í•­' },
        { name: 'í•˜íš¨í•­', lat: 33.23, lon: 126.58, region: 'ì œì£¼', station: 'DT_0010', stationName: 'ì„œê·€í¬', current: '08JJ07', currentName: 'ì„œê·€í¬' },
        { name: 'ê¹€ë…•í•­', lat: 33.55, lon: 126.77, region: 'ì œì£¼', station: 'DT_0022', stationName: 'ì„±ì‚°í¬', current: '08JJ03', currentName: 'ì„±ì‚°í¬' },
        { name: 'í•œë¦¼í•­', lat: 33.42, lon: 126.27, region: 'ì œì£¼', station: 'DT_0004', stationName: 'ì œì£¼', current: '08JJ13', currentName: 'ì• ì›”í•­ë¶ì¸¡' },
        { name: 'ëŒ€í¬í•­', lat: 35.16, lon: 129.18, region: 'ê²½ë‚¨', station: 'DT_0005', stationName: 'ë¶€ì‚°', current: '18LTC13', currentName: 'í•´ìš´ëŒ€' },
        { name: 'êµ¬ë£¡í¬í•­', lat: 35.98, lon: 129.57, region: 'ê²½ë¶', station: 'DT_0091', stationName: 'í¬í•­', current: '17LTC05', currentName: 'ìš¸ë„' },
        { name: 'ì¶•ì‚°í•­', lat: 36.43, lon: 129.45, region: 'ê²½ë¶', station: 'DT_0011', stationName: 'í›„í¬', current: '17LTC07', currentName: 'ìš¸ë„ë‚¨ì¸¡' },
        { name: 'ì¥í˜¸í•­', lat: 37.28, lon: 129.33, region: 'ê°•ì›', station: 'DT_0057', stationName: 'ë™í•´í•­', current: null, currentName: null },
        { name: 'ì„ì›í•­', lat: 37.25, lon: 129.35, region: 'ê°•ì›', station: 'DT_0057', stationName: 'ë™í•´í•­', current: null, currentName: null },
    ];

    let khoaCurrentChart = null;
    let portTideChart = null;
    let portCurrentChart = null;

    // ==================== ê´€ì¸¡ì†Œ/ì¡°ë¥˜ ì—°ë™ ====================
    function getRegionByStationCode(code) {
        for (const r of REGIONS) {
            if (r.stations.some(s => s[0] === code)) return r;
        }
        return REGIONS[0];
    }

    function buildStationSelect() {
        const sel = document.getElementById('stationSelect');
        sel.innerHTML = '';
        for (const r of REGIONS) {
            const og = document.createElement('optgroup');
            og.label = r.label;
            for (const [code, name] of r.stations) {
                const opt = document.createElement('option');
                opt.value = code; opt.textContent = name;
                og.appendChild(opt);
            }
            sel.appendChild(og);
        }
    }

    function buildCurrentSelect(region) {
        const sel = document.getElementById('currentSelect');
        sel.innerHTML = '';
        if (!region || region.currents.length === 0) {
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = '(ì´ ì§€ì—­ì— ì¡°ë¥˜ ì˜ˆë³´ì  ì—†ìŒ)';
            sel.appendChild(opt);
            return;
        }
        const og = document.createElement('optgroup');
        og.label = region.label;
        for (const [code, name] of region.currents) {
            const opt = document.createElement('option');
            opt.value = code; opt.textContent = name;
            og.appendChild(opt);
        }
        sel.appendChild(og);
    }

    function updateRegionBadges(region) {
        document.getElementById('stationRegion').textContent = region.label;
        document.getElementById('currentRegion').textContent = region.label;
    }

    function onStationChange() {
        const code = document.getElementById('stationSelect').value;
        const region = getRegionByStationCode(code);
        buildCurrentSelect(region);
        updateRegionBadges(region);
    }

    // ==================== ê²€ìƒ‰ ê¸°ëŠ¥ ====================
    function buildSearchIndex() {
        const index = [];
        for (const r of REGIONS) {
            for (const [code, name] of r.stations) {
                index.push({ type: 'obs', code, name, region: r, regionLabel: r.label });
            }
            for (const [code, name] of r.currents) {
                index.push({ type: 'crnt', code, name, region: r, regionLabel: r.label });
            }
        }
        // ë‚šì‹œ í¬ì¸íŠ¸ í”„ë¦¬ì…‹ ì¶”ê°€
        for (const port of FISHING_PORTS) {
            index.push({ type: 'port', name: port.name, lat: port.lat, lon: port.lon, regionLabel: port.region });
        }
        return index;
    }

    const searchIndex = buildSearchIndex();

    function doSearch(query) {
        const q = query.trim().toLowerCase();
        if (!q) return [];
        return searchIndex.filter(item =>
            item.name.toLowerCase().includes(q) ||
            item.regionLabel.toLowerCase().includes(q) ||
            (item.code && item.code.toLowerCase().includes(q))
        ).slice(0, 15);
    }

    function highlightMatch(text, query) {
        const idx = text.toLowerCase().indexOf(query.toLowerCase());
        if (idx < 0) return text;
        return text.substring(0, idx) + '<em>' + text.substring(idx, idx + query.length) + '</em>' + text.substring(idx + query.length);
    }

    function renderSearchResults(results, query) {
        const el = document.getElementById('searchResults');
        if (results.length === 0) {
            el.innerHTML = '<div class="search-no-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            el.classList.add('show');
            return;
        }
        el.innerHTML = results.map((item, i) => {
            const typeLabel = item.type === 'obs' ? 'ê´€ì¸¡ì†Œ' : item.type === 'crnt' ? 'ì¡°ë¥˜ì˜ˆë³´ì ' : 'ğŸ“ ë‚šì‹œí¬ì¸íŠ¸';
            const typeClass = item.type === 'port' ? 'crnt' : item.type;
            return `
            <div class="search-result-item" data-idx="${i}">
                <div class="name">${highlightMatch(item.name, query)}</div>
                <div class="tags">
                    <span class="tag ${typeClass}">${typeLabel}</span>
                    <span class="tag region">${item.regionLabel}</span>
                </div>
            </div>`;
        }).join('');
        el.classList.add('show');

        el.querySelectorAll('.search-result-item').forEach(div => {
            div.addEventListener('click', () => {
                const idx = parseInt(div.dataset.idx);
                selectSearchResult(results[idx]);
            });
        });
    }

    function selectSearchResult(item) {
        const stationSel = document.getElementById('stationSelect');
        const currentSel = document.getElementById('currentSelect');

        if (item.type === 'port') {
            // ë‚šì‹œ í¬ì¸íŠ¸ â†’ ë‚šì‹œí¬ì¸íŠ¸ íƒ­ìœ¼ë¡œ ì „í™˜
            const portSel = document.getElementById('fishingPortSelect');
            portSel.value = item.name;
            onFishingPortChange();
            // íƒ­ ì „í™˜
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="coord-current"]').classList.add('active');
            document.getElementById('tab-coord-current').classList.add('active');
            // ê²€ìƒ‰ì°½ ë‹«ê¸°
            document.getElementById('searchInput').value = item.name;
            document.getElementById('searchResults').classList.remove('show');
            // ìë™ ì¡°íšŒ
            fetchPortData();
            return;
        }

        // í•´ë‹¹ ì§€ì—­ì˜ ê´€ì¸¡ì†Œë¥¼ ì²« ë²ˆì§¸ë¡œ ì„ íƒ
        const region = item.region;
        if (item.type === 'obs') {
            stationSel.value = item.code;
        } else {
            // ì¡°ë¥˜ì˜ˆë³´ì ì´ë©´ í•´ë‹¹ ì§€ì—­ì˜ ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œ ì„ íƒ
            if (region.stations.length > 0) {
                stationSel.value = region.stations[0][0];
            }
        }
        // ì§€ì—­ì— ë§ëŠ” ì¡°ë¥˜ ì˜ˆë³´ì  ëª©ë¡ ê°±ì‹ 
        buildCurrentSelect(region);
        updateRegionBadges(region);

        if (item.type === 'crnt') {
            currentSel.value = item.code;
        }

        // ê²€ìƒ‰ì°½ ë‹«ê¸°
        document.getElementById('searchInput').value = item.name;
        document.getElementById('searchResults').classList.remove('show');
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        document.getElementById('dateInput').value = today.toISOString().split('T')[0];

        // ê´€ì¸¡ì†Œ/ì¡°ë¥˜ ì—°ë™ ì´ˆê¸°í™”
        buildStationSelect();
        onStationChange();

        // ë‚šì‹œ í¬ì¸íŠ¸ í”„ë¦¬ì…‹ ì´ˆê¸°í™”
        buildFishingPortSelect();
        document.getElementById('stationSelect').addEventListener('change', onStationChange);

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // ê²€ìƒ‰ ì´ë²¤íŠ¸
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let debounceTimer = null;

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const q = searchInput.value.trim();
                if (q.length === 0) { searchResults.classList.remove('show'); return; }
                const results = doSearch(q);
                renderSearchResults(results, q);
            }, 150);
        });

        searchInput.addEventListener('focus', () => {
            const q = searchInput.value.trim();
            if (q.length > 0) {
                const results = doSearch(q);
                renderSearchResults(results, q);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-bar')) {
                searchResults.classList.remove('show');
            }
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') searchResults.classList.remove('show');
        });
    });

    function showToast(msg, isError = false) {
        let toast = document.getElementById('toastMsg');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toastMsg';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;color:#fff;font-size:14px;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;';
            document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.background = isError ? '#e74c3c' : '#00e0ff';
        toast.style.color = isError ? '#fff' : '#0a0f1a';
        toast.style.opacity = '1';
        setTimeout(() => { toast.style.opacity = '0'; }, 2500);
    }

    function getDateStr() { return document.getElementById('dateInput').value.replace(/-/g, ''); }
    function getStation() { return document.getElementById('stationSelect').value; }
    function getCurrentStation() { return document.getElementById('currentSelect').value; }

    // ==================== GENERIC API CALL (Worker í”„ë¡ì‹œ ê²½ìœ ) ====================
    const PROXY_ENDPOINT_MAP = {
        'tideFcstHghLw/GetTideFcstHghLwApiService': '/api/tide-hilo',
        'surveyTideLevel/GetSurveyTideLevelApiService': '/api/tide-level',
        'crntFcstTime/GetCrntFcstTimeApiService': '/api/current',
    };

    async function apiCall(path, params) {
        const endpoint = PROXY_ENDPOINT_MAP[path];
        if (!endpoint) throw new Error(`Unknown API path: ${path}`);

        const url = new URL(`${API_BASE}${endpoint}`);
        if (params.obsCode) url.searchParams.set('obsCode', params.obsCode);
        if (params.reqDate) url.searchParams.set('reqDate', params.reqDate);

        const resp = await fetch(url.toString());
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const json = await resp.json();

        if (json.header && json.header.resultCode !== '00') {
            throw new Error(json.header.resultMsg || 'API ì˜¤ë¥˜');
        }
        return json.body?.items?.item || [];
    }

    // ==================== FETCH ALL ====================
    async function fetchAll() {
        const btn = document.getElementById('searchBtn');
        btn.disabled = true; btn.textContent = 'ì¡°íšŒ ì¤‘...';
        try {
            await Promise.all([fetchTideHighLow(), fetchTidePrediction(), fetchCurrentData()]);
        } catch(e) { console.error(e); }
        finally { btn.disabled = false; btn.textContent = 'ì¡°íšŒ'; }
    }

    // ==================== 1) ê³ ì €ì¡° (tideFcstHghLw) ====================
    async function fetchTideHighLow() {
        const summaryEl = document.getElementById('tideSummary');
        const detailEl = document.getElementById('tideDetail');
        summaryEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>ê³ ì €ì¡° ë°ì´í„° ë¡œë”©...</div></div>';

        try {
            const items = await apiCall('tideFcstHghLw/GetTideFcstHghLwApiService', {
                obsCode: getStation(),
                reqDate: getDateStr(),
                numOfRows: '20',
                pageNo: '1'
            });

            if (!items || items.length === 0) {
                summaryEl.innerHTML = '<div class="error-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                detailEl.innerHTML = '';
                return;
            }

            const dateStr = getDateStr();
            const datePrefix = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
            const todayItems = items.filter(i => i.predcDt && i.predcDt.startsWith(datePrefix));
            const displayItems = todayItems.length > 0 ? todayItems : items.slice(0, 4);

            const highs = displayItems.filter(i => parseInt(i.extrSe) % 2 === 1);
            const lows = displayItems.filter(i => parseInt(i.extrSe) % 2 === 0);

            const maxHigh = highs.length > 0 ? Math.max(...highs.map(h => h.predcTdlvVl)) : null;
            const minLow = lows.length > 0 ? Math.min(...lows.map(l => l.predcTdlvVl)) : null;
            const diff = (maxHigh !== null && minLow !== null) ? maxHigh - minLow : null;

            const bestHigh = highs.length > 0 ? highs.reduce((a, b) => a.predcTdlvVl > b.predcTdlvVl ? a : b) : null;
            const bestLow = lows.length > 0 ? lows.reduce((a, b) => a.predcTdlvVl < b.predcTdlvVl ? a : b) : null;

            summaryEl.innerHTML = `
                <div class="tide-summary">
                    <div class="tide-item high">
                        <div class="label">ìµœê³ ì¡°ìœ„</div>
                        <div class="value">${maxHigh !== null ? maxHigh.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div>
                        <div class="time">${bestHigh ? bestHigh.predcDt.substring(11, 16) : '-'}</div>
                    </div>
                    <div class="tide-item low">
                        <div class="label">ìµœì €ì¡°ìœ„</div>
                        <div class="value">${minLow !== null ? minLow.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div>
                        <div class="time">${bestLow ? bestLow.predcDt.substring(11, 16) : '-'}</div>
                    </div>
                    <div class="tide-item diff">
                        <div class="label">ì¡°ì°¨ (ê³ ì €ì°¨)</div>
                        <div class="value">${diff !== null ? diff.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div>
                        <div class="time">${diff !== null ? (diff / 100).toFixed(2) + ' m' : '-'}</div>
                    </div>
                </div>`;

            detailEl.innerHTML = `
                <div class="tide-detail-list">
                    ${displayItems.map(i => {
                        const isHigh = parseInt(i.extrSe) % 2 === 1;
                        const label = isHigh ? 'ê³ ì¡°' : 'ì €ì¡°';
                        return `<div class="tide-tag ${isHigh ? 'high' : 'low'}">${label} ${i.predcDt.substring(11, 16)} Â· ${i.predcTdlvVl.toFixed(0)}cm</div>`;
                    }).join('')}
                </div>`;

            window._hlData = displayItems;
        } catch(e) {
            summaryEl.innerHTML = `<div class="error-msg">ê³ ì €ì¡° ì˜¤ë¥˜: ${e.message}</div>`;
            detailEl.innerHTML = '';
        }
    }

    // ==================== 2) 10ë¶„ ë‹¨ìœ„ ì¡°ìœ„ ê·¸ë˜í”„ (surveyTideLevel) ====================
    async function fetchTidePrediction() {
        try {
            const items = await apiCall('surveyTideLevel/GetSurveyTideLevelApiService', {
                obsCode: getStation(),
                reqDate: getDateStr(),
                min: '10',
                numOfRows: '300',
                pageNo: '1'
            });

            if (!items || items.length === 0) {
                renderTideChart([], []); return;
            }

            const labels = items.map(d => d.obsrvnDt.substring(11, 16));
            const predicted = items.map(d => d.bscTdlvHgt);
            const actual = items.map(d => d.tdlvHgt);

            let annotations = {};
            const hlData = window._hlData || [];
            hlData.forEach((item, idx) => {
                const time = item.predcDt.substring(11, 16);
                const nearIdx = labels.findIndex(l => {
                    const [h1, m1] = l.split(':').map(Number);
                    const [h2, m2] = time.split(':').map(Number);
                    return Math.abs((h1 * 60 + m1) - (h2 * 60 + m2)) <= 5;
                });
                if (nearIdx < 0) return;
                const isHigh = parseInt(item.extrSe) % 2 === 1;

                annotations['hl_' + idx] = {
                    type: 'point', xValue: nearIdx, yValue: item.predcTdlvVl,
                    backgroundColor: isHigh ? 'rgba(255,107,107,0.8)' : 'rgba(78,205,196,0.8)',
                    radius: 7, borderColor: '#fff', borderWidth: 2,
                };
                annotations['hl_label_' + idx] = {
                    type: 'label', xValue: nearIdx,
                    yValue: item.predcTdlvVl + (isHigh ? 20 : -20),
                    content: `${isHigh ? 'ê³ ì¡°' : 'ì €ì¡°'} ${item.predcTdlvVl.toFixed(0)}cm`,
                    color: isHigh ? '#ff6b6b' : '#4ecdc4',
                    font: { size: 11, weight: 'bold' },
                };
            });

            renderTideChart(labels, predicted, actual, annotations);
        } catch(e) {
            console.error('ì¡°ìœ„ ê·¸ë˜í”„ ì˜¤ë¥˜:', e);
            renderTideChart([], []);
        }
    }

    function renderTideChart(labels, predicted, actual, annotations = {}) {
        const ctx = document.getElementById('tideChart').getContext('2d');
        if (tideChart) tideChart.destroy();
        if (labels.length === 0) { tideChart = null; return; }

        const grad1 = ctx.createLinearGradient(0, 0, 0, 320);
        grad1.addColorStop(0, 'rgba(79,195,247,0.3)');
        grad1.addColorStop(1, 'rgba(79,195,247,0.02)');

        const datasets = [{
            label: 'ì˜ˆì¸¡ ì¡°ìœ„ (cm)',
            data: predicted,
            borderColor: '#4fc3f7',
            backgroundColor: grad1,
            borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5,
        }];

        if (actual && actual.length > 0 && actual.some((v, i) => v !== predicted[i])) {
            datasets.push({
                label: 'ì‹¤ì¸¡ ì¡°ìœ„ (cm)',
                data: actual,
                borderColor: '#ffa726',
                borderWidth: 1.5, borderDash: [4, 4],
                fill: false, tension: 0.4, pointRadius: 0, pointHoverRadius: 5,
            });
        }

        tideChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: datasets.length > 1, labels: { color: '#7a8ba3', font: { size: 11 } } },
                    tooltip: {
                        backgroundColor: 'rgba(17,29,53,0.95)', titleColor: '#4fc3f7',
                        bodyColor: '#e0e6ed', borderColor: '#1e3a5f', borderWidth: 1, padding: 12,
                        callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y.toFixed(1)} cm` }
                    },
                    annotation: { annotations }
                },
                scales: {
                    x: { ticks: { color: '#7a8ba3', maxTicksLimit: 12, font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#7a8ba3', font: { size: 11 }, callback: v => v + ' cm' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                }
            }
        });
    }

    // ==================== 3) ì¡°ë¥˜ (crntFcstTime ì‹œê³„ì—´) ====================
    async function fetchCurrentData() {
        const infoEl = document.getElementById('currentInfo');
        const cStation = getCurrentStation();
        if (!cStation) {
            infoEl.innerHTML = '<div class="error-msg">ì´ ì§€ì—­ì—ëŠ” ì¡°ë¥˜ ì˜ˆë³´ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            renderCurrentChart([]);
            return;
        }
        infoEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>ì¡°ë¥˜ ë°ì´í„° ë¡œë”©...</div></div>';

        try {
            const items = await apiCall('crntFcstTime/GetCrntFcstTimeApiService', {
                obsCode: cStation,
                reqDate: getDateStr(),
                numOfRows: '300',
                pageNo: '1'
            });

            if (!items || items.length === 0) {
                infoEl.innerHTML = '<div class="error-msg">ì¡°ë¥˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ˆë³´ì ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                renderCurrentChart([]); return;
            }

            const filtered = items.filter((_, idx) => idx % 10 === 0);
            renderCurrentTable(filtered, infoEl);
            renderCurrentChart(filtered);
        } catch(e) {
            infoEl.innerHTML = `<div class="error-msg">ì¡°ë¥˜ ì˜¤ë¥˜: ${e.message}</div>`;
            renderCurrentChart([]);
        }
    }

    function getSpeedColor(speed) {
        const s = parseFloat(speed);
        if (s >= 100) return '#ff6b6b';
        if (s >= 50) return '#ffa726';
        if (s >= 20) return '#4fc3f7';
        return '#4ecdc4';
    }

    function renderCurrentTable(items, el) {
        const maxSpeed = Math.max(...items.map(i => parseFloat(i.crsp) || 0), 1);

        el.innerHTML = `
            <div style="margin-bottom:10px;font-size:0.82em;color:var(--muted);">
                ì˜ˆë³´ì : <strong style="color:var(--text)">${items[0]?.obsvtrNm || '-'}</strong> Â·
                ì´ ${items.length}ê±´ (10ë¶„ ê°„ê²©)
            </div>
            <div style="max-height:400px;overflow-y:auto;">
            <table class="current-table">
                <thead><tr><th>ì‹œê°„</th><th>ìœ í–¥</th><th>ìœ ì† (cm/s)</th><th>ì„¸ê¸°</th></tr></thead>
                <tbody>
                    ${items.map(item => {
                        const time = item.predcDt ? item.predcDt.substring(11, 16) : '-';
                        const speed = parseFloat(item.crsp) || 0;
                        const pct = (speed / maxSpeed) * 100;
                        const color = getSpeedColor(speed);
                        return `<tr>
                            <td>${time}</td>
                            <td style="color:${color};">${item.crdir || '-'}</td>
                            <td>${speed.toFixed(1)}</td>
                            <td style="min-width:100px;"><div class="speed-bar"><div class="speed-bar-fill" style="width:${pct}%;background:${color};"></div></div></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
            </div>`;
    }

    function renderCurrentChart(items) {
        const ctx = document.getElementById('currentChart').getContext('2d');
        if (currentChart) currentChart.destroy();
        if (!items || items.length === 0) { currentChart = null; return; }

        const labels = items.map(i => i.predcDt ? i.predcDt.substring(11, 16) : '-');
        const speeds = items.map(i => parseFloat(i.crsp) || 0);

        const gradient = ctx.createLinearGradient(0, 0, 0, 320);
        gradient.addColorStop(0, 'rgba(0,229,255,0.3)');
        gradient.addColorStop(1, 'rgba(0,229,255,0.02)');

        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'ìœ ì† (cm/s)', data: speeds,
                    borderColor: '#00e5ff', backgroundColor: gradient,
                    borderWidth: 2, fill: true, tension: 0.4,
                    pointRadius: 0, pointHoverRadius: 5,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17,29,53,0.95)', titleColor: '#00e5ff',
                        bodyColor: '#e0e6ed', borderColor: '#1e3a5f', borderWidth: 1, padding: 12,
                        callbacks: { label: c => `ìœ ì†: ${c.parsed.y.toFixed(1)} cm/s` }
                    }
                },
                scales: {
                    x: { ticks: { color: '#7a8ba3', maxTicksLimit: 12, font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#7a8ba3', font: { size: 11 }, callback: v => v + ' cm/s' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                }
            }
        });
    }
    // ==================== ë‚šì‹œ í¬ì¸íŠ¸ í”„ë¦¬ì…‹ ====================
    function buildFishingPortSelect() {
        const sel = document.getElementById('fishingPortSelect');
        const regions = {};
        for (const port of FISHING_PORTS) {
            if (!regions[port.region]) regions[port.region] = [];
            regions[port.region].push(port);
        }
        for (const [region, ports] of Object.entries(regions)) {
            const og = document.createElement('optgroup');
            og.label = region;
            for (const port of ports) {
                const opt = document.createElement('option');
                opt.value = port.name;
                opt.textContent = port.name;
                opt.dataset.region = port.region;
                og.appendChild(opt);
            }
            sel.appendChild(og);
        }
    }

    function getSelectedPort() {
        const name = document.getElementById('fishingPortSelect').value;
        return FISHING_PORTS.find(p => p.name === name) || null;
    }

    function onFishingPortChange() {
        const port = getSelectedPort();
        const mappingEl = document.getElementById('portMapping');
        if (!port) {
            document.getElementById('portRegion').textContent = 'ì„ íƒ';
            mappingEl.innerHTML = '';
            return;
        }
        document.getElementById('portRegion').textContent = port.region;
        const currentInfo = port.current ? `ì¡°ë¥˜: <strong style="color:var(--accent)">${port.currentName}</strong> (${port.current})` : 'ì¡°ë¥˜: <span style="color:var(--muted)">ì˜ˆë³´ì  ì—†ìŒ</span>';
        mappingEl.innerHTML = `ì—°ê²° ê´€ì¸¡ì†Œ â†’ ì¡°ìœ„: <strong style="color:var(--primary)">${port.stationName}</strong> (${port.station}) Â· ${currentInfo}`;
    }

    // ==================== ë‚šì‹œ í¬ì¸íŠ¸ ì „ì²´ ë°ì´í„° ì¡°íšŒ ====================
    async function fetchPortData() {
        const port = getSelectedPort();
        if (!port) {
            showToast('ë‚šì‹œ í¬ì¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”', true);
            return;
        }

        const btn = document.getElementById('coordSearchBtn');
        btn.disabled = true; btn.textContent = 'ì¡°íšŒ ì¤‘...';

        // ì¹´ë“œ í‘œì‹œ
        document.getElementById('portTideSummaryCard').style.display = '';
        document.getElementById('portTideChartCard').style.display = '';
        document.getElementById('portTideStation').textContent = `${port.stationName} ê´€ì¸¡ì†Œ`;

        const promises = [
            fetchPortTideHighLow(port),
            fetchPortTideLevel(port)
        ];

        if (port.current) {
            document.getElementById('portCurrentCard').style.display = '';
            document.getElementById('portCurrentChartCard').style.display = '';
            document.getElementById('portCurrentStation').textContent = `${port.currentName} ì˜ˆë³´ì `;
            promises.push(fetchPortCurrentData(port));
        } else {
            document.getElementById('portCurrentCard').style.display = 'none';
            document.getElementById('portCurrentChartCard').style.display = 'none';
        }

        try {
            await Promise.all(promises);
        } catch(e) { console.error('í¬ì¸íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', e); }
        finally { btn.disabled = false; btn.textContent = 'ì¡°íšŒ'; }
    }

    // ==================== ë‚šì‹œ í¬ì¸íŠ¸: ê³ ì €ì¡° ====================
    async function fetchPortTideHighLow(port) {
        const summaryEl = document.getElementById('portTideSummary');
        summaryEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>ê³ ì €ì¡° ë°ì´í„° ë¡œë”©...</div></div>';

        try {
            const items = await apiCall('tideFcstHghLw/GetTideFcstHghLwApiService', {
                obsCode: port.station, reqDate: getDateStr()
            });

            if (!items || items.length === 0) {
                summaryEl.innerHTML = '<div class="error-msg">ê³ ì €ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const dateStr = getDateStr();
            const datePrefix = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
            const todayItems = items.filter(i => i.predcDt && i.predcDt.startsWith(datePrefix));
            const displayItems = todayItems.length > 0 ? todayItems : items.slice(0, 4);

            const highs = displayItems.filter(i => parseInt(i.extrSe) % 2 === 1);
            const lows = displayItems.filter(i => parseInt(i.extrSe) % 2 === 0);
            const maxHigh = highs.length > 0 ? Math.max(...highs.map(h => h.predcTdlvVl)) : null;
            const minLow = lows.length > 0 ? Math.min(...lows.map(l => l.predcTdlvVl)) : null;
            const diff = (maxHigh !== null && minLow !== null) ? maxHigh - minLow : null;
            const bestHigh = highs.length > 0 ? highs.reduce((a, b) => a.predcTdlvVl > b.predcTdlvVl ? a : b) : null;
            const bestLow = lows.length > 0 ? lows.reduce((a, b) => a.predcTdlvVl < b.predcTdlvVl ? a : b) : null;

            summaryEl.innerHTML = `
                <div class="tide-summary">
                    <div class="tide-item high"><div class="label">ìµœê³ ì¡°ìœ„</div><div class="value">${maxHigh !== null ? maxHigh.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div><div class="time">${bestHigh ? bestHigh.predcDt.substring(11, 16) : '-'}</div></div>
                    <div class="tide-item low"><div class="label">ìµœì €ì¡°ìœ„</div><div class="value">${minLow !== null ? minLow.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div><div class="time">${bestLow ? bestLow.predcDt.substring(11, 16) : '-'}</div></div>
                    <div class="tide-item diff"><div class="label">ì¡°ì°¨</div><div class="value">${diff !== null ? diff.toFixed(0) : '-'}<small style="font-size:0.4em"> cm</small></div><div class="time">${diff !== null ? (diff / 100).toFixed(2) + ' m' : '-'}</div></div>
                </div>
                <div class="tide-detail-list" style="margin-top:12px;">
                    ${displayItems.map(i => {
                        const isHigh = parseInt(i.extrSe) % 2 === 1;
                        return `<div class="tide-tag ${isHigh ? 'high' : 'low'}">${isHigh ? 'ê³ ì¡°' : 'ì €ì¡°'} ${i.predcDt.substring(11, 16)} Â· ${i.predcTdlvVl.toFixed(0)}cm</div>`;
                    }).join('')}
                </div>`;

            window._portHlData = displayItems;
        } catch(e) {
            summaryEl.innerHTML = `<div class="error-msg">ê³ ì €ì¡° ì˜¤ë¥˜: ${e.message}</div>`;
        }
    }

    // ==================== ë‚šì‹œ í¬ì¸íŠ¸: ì¡°ìœ„ ê·¸ë˜í”„ ====================
    async function fetchPortTideLevel(port) {
        try {
            const items = await apiCall('surveyTideLevel/GetSurveyTideLevelApiService', {
                obsCode: port.station, reqDate: getDateStr()
            });

            if (!items || items.length === 0) {
                renderPortTideChart([], []); return;
            }

            const labels = items.map(d => d.obsrvnDt.substring(11, 16));
            const predicted = items.map(d => d.bscTdlvHgt);
            const actual = items.map(d => d.tdlvHgt);

            let annotations = {};
            const hlData = window._portHlData || [];
            hlData.forEach((item, idx) => {
                const time = item.predcDt.substring(11, 16);
                const nearIdx = labels.findIndex(l => {
                    const [h1, m1] = l.split(':').map(Number);
                    const [h2, m2] = time.split(':').map(Number);
                    return Math.abs((h1 * 60 + m1) - (h2 * 60 + m2)) <= 5;
                });
                if (nearIdx < 0) return;
                const isHigh = parseInt(item.extrSe) % 2 === 1;
                annotations['hl_' + idx] = {
                    type: 'point', xValue: nearIdx, yValue: item.predcTdlvVl,
                    backgroundColor: isHigh ? 'rgba(255,107,107,0.8)' : 'rgba(78,205,196,0.8)',
                    radius: 7, borderColor: '#fff', borderWidth: 2,
                };
                annotations['hl_label_' + idx] = {
                    type: 'label', xValue: nearIdx,
                    yValue: item.predcTdlvVl + (isHigh ? 20 : -20),
                    content: `${isHigh ? 'ê³ ì¡°' : 'ì €ì¡°'} ${item.predcTdlvVl.toFixed(0)}cm`,
                    color: isHigh ? '#ff6b6b' : '#4ecdc4',
                    font: { size: 11, weight: 'bold' },
                };
            });

            renderPortTideChart(labels, predicted, actual, annotations);
        } catch(e) {
            console.error('í¬ì¸íŠ¸ ì¡°ìœ„ ê·¸ë˜í”„ ì˜¤ë¥˜:', e);
            renderPortTideChart([], []);
        }
    }

    function renderPortTideChart(labels, predicted, actual, annotations = {}) {
        const ctx = document.getElementById('portTideChart').getContext('2d');
        if (portTideChart) portTideChart.destroy();
        if (labels.length === 0) { portTideChart = null; return; }

        const grad = ctx.createLinearGradient(0, 0, 0, 320);
        grad.addColorStop(0, 'rgba(79,195,247,0.3)');
        grad.addColorStop(1, 'rgba(79,195,247,0.02)');

        const datasets = [{
            label: 'ì˜ˆì¸¡ ì¡°ìœ„ (cm)', data: predicted,
            borderColor: '#4fc3f7', backgroundColor: grad,
            borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5,
        }];

        if (actual && actual.length > 0 && actual.some((v, i) => v !== predicted[i])) {
            datasets.push({
                label: 'ì‹¤ì¸¡ ì¡°ìœ„ (cm)', data: actual,
                borderColor: '#ffa726', borderWidth: 1.5, borderDash: [4, 4],
                fill: false, tension: 0.4, pointRadius: 0, pointHoverRadius: 5,
            });
        }

        portTideChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: datasets.length > 1, labels: { color: '#7a8ba3', font: { size: 11 } } },
                    tooltip: {
                        backgroundColor: 'rgba(17,29,53,0.95)', titleColor: '#4fc3f7',
                        bodyColor: '#e0e6ed', borderColor: '#1e3a5f', borderWidth: 1, padding: 12,
                        callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y.toFixed(1)} cm` }
                    },
                    annotation: { annotations }
                },
                scales: {
                    x: { ticks: { color: '#7a8ba3', maxTicksLimit: 12, font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#7a8ba3', font: { size: 11 }, callback: v => v + ' cm' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                }
            }
        });
    }

    // ==================== ë‚šì‹œ í¬ì¸íŠ¸: ì¡°ë¥˜ ====================
    async function fetchPortCurrentData(port) {
        const infoEl = document.getElementById('portCurrentInfo');
        infoEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>ì¡°ë¥˜ ë°ì´í„° ë¡œë”©...</div></div>';

        try {
            const items = await apiCall('crntFcstTime/GetCrntFcstTimeApiService', {
                obsCode: port.current, reqDate: getDateStr()
            });

            if (!items || items.length === 0) {
                infoEl.innerHTML = '<div class="error-msg">ì¡°ë¥˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                renderPortCurrentChart([]); return;
            }

            const filtered = items.filter((_, idx) => idx % 10 === 0);
            renderPortCurrentTable(filtered, infoEl, port);
            renderPortCurrentChart(filtered);
        } catch(e) {
            infoEl.innerHTML = `<div class="error-msg">ì¡°ë¥˜ ì˜¤ë¥˜: ${e.message}</div>`;
            renderPortCurrentChart([]);
        }
    }

    function renderPortCurrentTable(items, el, port) {
        const maxSpeed = Math.max(...items.map(i => parseFloat(i.crsp) || 0), 1);
        el.innerHTML = `
            <div style="margin-bottom:10px;font-size:0.82em;color:var(--muted);">
                ${port.name} â†’ ì¡°ë¥˜ ì˜ˆë³´ì : <strong style="color:var(--text)">${port.currentName}</strong> (${port.current}) Â· ${items.length}ê±´
            </div>
            <div style="max-height:400px;overflow-y:auto;">
            <table class="current-table">
                <thead><tr><th>ì‹œê°„</th><th>ìœ í–¥</th><th>ìœ ì† (cm/s)</th><th>ì„¸ê¸°</th></tr></thead>
                <tbody>
                    ${items.map(item => {
                        const time = item.predcDt ? item.predcDt.substring(11, 16) : '-';
                        const speed = parseFloat(item.crsp) || 0;
                        const pct = (speed / maxSpeed) * 100;
                        const color = getSpeedColor(speed);
                        return `<tr>
                            <td>${time}</td>
                            <td style="color:${color};">${item.crdir || '-'}</td>
                            <td>${speed.toFixed(1)}</td>
                            <td style="min-width:100px;"><div class="speed-bar"><div class="speed-bar-fill" style="width:${pct}%;background:${color};"></div></div></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
            </div>`;
    }

    function renderPortCurrentChart(items) {
        const ctx = document.getElementById('portCurrentChart').getContext('2d');
        if (portCurrentChart) portCurrentChart.destroy();
        if (!items || items.length === 0) { portCurrentChart = null; return; }

        const labels = items.map(i => i.predcDt ? i.predcDt.substring(11, 16) : '-');
        const speeds = items.map(i => parseFloat(i.crsp) || 0);

        const gradient = ctx.createLinearGradient(0, 0, 0, 320);
        gradient.addColorStop(0, 'rgba(0,229,255,0.3)');
        gradient.addColorStop(1, 'rgba(0,229,255,0.02)');

        portCurrentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'ìœ ì† (cm/s)', data: speeds,
                    borderColor: '#00e5ff', backgroundColor: gradient,
                    borderWidth: 2, fill: true, tension: 0.4,
                    pointRadius: 0, pointHoverRadius: 5,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17,29,53,0.95)', titleColor: '#00e5ff',
                        bodyColor: '#e0e6ed', borderColor: '#1e3a5f', borderWidth: 1, padding: 12,
                        callbacks: { label: c => `ìœ ì†: ${c.parsed.y.toFixed(1)} cm/s` }
                    }
                },
                scales: {
                    x: { ticks: { color: '#7a8ba3', maxTicksLimit: 12, font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#7a8ba3', font: { size: 11 }, callback: v => v + ' cm/s' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                }
            }
        });
    }
    </script>
</body>
</html>
